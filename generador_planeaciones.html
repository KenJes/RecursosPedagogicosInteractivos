<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Planeaciones Pedag√≥gicas UAEM√©x</title>
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    
    <!-- Librer√≠as para generar PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <style>
        :root {
            --uaemex-green: #006341;
            --uaemex-gold: #B8860B;
            --uaemex-light-green: #00875A;
            --uaemex-dark-green: #004d2e;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            min-height: 100vh;
            padding: 20px 0;
        }

        .main-header {
            background: linear-gradient(135deg, var(--uaemex-dark-green), var(--uaemex-green));
            color: white;
            padding: 30px 0;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            animation: slideDown 0.5s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .card {
            border: none;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            animation: fadeIn 0.6s ease-out;
            animation-fill-mode: both;
        }

        .card:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }

        .card:nth-child(1) { animation-delay: 0.1s; }
        .card:nth-child(2) { animation-delay: 0.2s; }
        .card:nth-child(3) { animation-delay: 0.3s; }
        .card:nth-child(4) { animation-delay: 0.4s; }

        .bg-gradient {
            background: linear-gradient(135deg, var(--uaemex-green), var(--uaemex-light-green)) !important;
        }

        .card-header {
            border: none;
            padding: 15px 20px;
            font-weight: 600;
            font-size: 1.1rem;
            border-radius: 15px 15px 0 0 !important;
        }

        .btn-uaemex {
            background: linear-gradient(135deg, var(--uaemex-green), var(--uaemex-light-green));
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .btn-uaemex:hover {
            background: linear-gradient(135deg, var(--uaemex-light-green), var(--uaemex-green));
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
            color: white;
        }

        .btn-uaemex:active {
            animation: pulse 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--uaemex-green);
            box-shadow: 0 0 0 0.25rem rgba(0, 99, 65, 0.25);
        }

        .form-check-input:checked {
            background-color: var(--uaemex-green);
            border-color: var(--uaemex-green);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 99, 65, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }

        .loading.active {
            display: flex;
        }

        @media (max-width: 768px) {
            .main-header h1 {
                font-size: 1.5rem;
            }
            .main-header p {
                font-size: 0.9rem;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="main-header">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-md-12 text-center">
                    <h1 class="display-4 mb-2"><i class="bi bi-journal-text"></i> Generador de Planeaciones Pedag√≥gicas</h1>
                    <p class="lead mb-0">Universidad Aut√≥noma del Estado de M√©xico - Sistema Integral con IA</p>
                </div>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <form id="planeacionForm">
            <!-- IA Section -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-robot"></i> Generaci√≥n con IA (GitHub Models)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-4">
                        <input class="form-check-input" type="checkbox" id="iaToggle" checked>
                        <label class="form-check-label fw-bold" for="iaToggle">
                            <span id="iaStatus">ü§ñ IA Activa</span>
                        </label>
                    </div>
                    
                    <div class="mb-3">
                        <label for="apiToken" class="form-label fw-bold">
                            <i class="bi bi-key"></i> Token de GitHub Models (requerido para IA)
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control font-monospace" id="apiToken" 
                                   placeholder="Pega tu token aqu√≠...">
                            <button type="button" class="btn btn-outline-success" onclick="probarToken()">
                                <i class="bi bi-lightning"></i> Probar Token
                            </button>
                        </div>
                        <div id="tokenStatus" class="mt-2" style="display: none;"></div>
                        <div class="form-text">
                            üí° <a href="https://github.com/settings/tokens" target="_blank" class="text-decoration-none">
                                Obt√©n tu token aqu√≠
                            </a> ‚Üí Generate new token (classic) ‚Üí No necesita permisos especiales<br>
                            ‚ö†Ô∏è Los tokens expiran. Si obtienes error 401, genera uno nuevo.
                        </div>
                    </div>
                    
                    <div class="alert alert-info mb-0">
                        <strong><i class="bi bi-info-circle"></i> Sobre la IA:</strong>
                        <ul class="mb-0 mt-2">
                            <li>Si tienes un token v√°lido, la IA analizar√° tus temarios autom√°ticamente</li>
                            <li>Si el token expira (error 401), puedes generar planeaci√≥n b√°sica sin IA</li>
                            <li>Tiempo estimado con IA: 30-60 segundos</li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n Institucional -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-building"></i> Informaci√≥n Institucional</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="plantel" class="form-label fw-bold">Plantel</label>
                            <input type="text" class="form-control" id="plantel" 
                                   value="Centro Universitario UAEM Temascaltepec" required>
                        </div>
                        <div class="col-md-6">
                            <label for="licenciatura" class="form-label fw-bold">Licenciatura</label>
                            <input type="text" class="form-control" id="licenciatura" 
                                   value="Inform√°tica Administrativa" 
                                   placeholder="Ej: Inform√°tica Administrativa" required>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label for="programaEducativo" class="form-label fw-bold">Programa Educativo</label>
                            <input type="text" class="form-control" id="programaEducativo" 
                                   value="2015" placeholder="Ej: 2015">
                        </div>
                        <div class="col-md-4">
                            <label for="areaCurricular" class="form-label fw-bold">√Årea de Curricular</label>
                            <input type="text" class="form-control" id="areaCurricular" 
                                   placeholder="Ej: Derecho Administrativo">
                        </div>
                        <div class="col-md-4">
                            <label for="clave" class="form-label fw-bold">Clave</label>
                            <input type="text" class="form-control" id="clave" 
                                   placeholder="Ej: LDE801">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="horasTeoria" class="form-label fw-bold">Horas de Teor√≠a</label>
                            <input type="number" class="form-control" id="horasTeoria" 
                                   value="3" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="horasPractica" class="form-label fw-bold">Horas de Pr√°ctica</label>
                            <input type="number" class="form-control" id="horasPractica" 
                                   value="1" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="totalHoras" class="form-label fw-bold">Total de Horas</label>
                            <input type="number" class="form-control" id="totalHoras" 
                                   value="4" min="0">
                        </div>
                        <div class="col-md-3">
                            <label for="creditos" class="form-label fw-bold">Cr√©ditos</label>
                            <input type="number" class="form-control" id="creditos" 
                                   value="7" min="0">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label for="tipoUnidad" class="form-label fw-bold">Tipo de Unidad</label>
                            <select class="form-select" id="tipoUnidad">
                                <option value="CURSO" selected>CURSO</option>
                                <option value="TALLER">TALLER</option>
                                <option value="LABORATORIO">LABORATORIO</option>
                                <option value="SEMINARIO">SEMINARIO</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="caracter" class="form-label fw-bold">Car√°cter</label>
                            <select class="form-select" id="caracter">
                                <option value="OBLIGATORIA" selected>OBLIGATORIA</option>
                                <option value="OPTATIVA">OPTATIVA</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="nucleoFormacion" class="form-label fw-bold">N√∫cleo de Formaci√≥n</label>
                            <select class="form-select" id="nucleoFormacion">
                                <option value="B√ÅSICO" selected>B√ÅSICO</option>
                                <option value="SUSTANTIVO">SUSTANTIVO</option>
                                <option value="INTEGRAL">INTEGRAL</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label for="modalidad" class="form-label fw-bold">Modalidad</label>
                            <select class="form-select" id="modalidad">
                                <option value="ESCOLARIZADA. SISTEMA FLEXIBLE" selected>ESCOLARIZADA. SISTEMA FLEXIBLE</option>
                                <option value="NO ESCOLARIZADA">NO ESCOLARIZADA</option>
                                <option value="MIXTA">MIXTA</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label for="prerrequisitos" class="form-label fw-bold">Prerrequisitos (Conocimientos Previos)</label>
                            <input type="text" class="form-control" id="prerrequisitos" 
                                   placeholder="Ej: Ninguno">
                        </div>
                        <div class="col-md-4">
                            <label for="unidadAntecedente" class="form-label fw-bold">Unidad de Aprendizaje Antecedente</label>
                            <input type="text" class="form-control" id="unidadAntecedente" 
                                   value="NINGUNO" placeholder="NINGUNO">
                        </div>
                        <div class="col-md-4">
                            <label for="unidadConsecuente" class="form-label fw-bold">Unidad de Aprendizaje Consecuente</label>
                            <input type="text" class="form-control" id="unidadConsecuente" 
                                   value="NINGUNO" placeholder="NINGUNO">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="docente" class="form-label fw-bold">Planeaci√≥n elaborada por</label>
                            <input type="text" class="form-control" id="docente" 
                                   value="IDGS. Kenneth de Jes√∫s Alcal√° Beltr√°n" 
                                   placeholder="Nombre del docente" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fechaElaboracion" class="form-label fw-bold">Fecha de Elaboraci√≥n</label>
                            <input type="date" class="form-control" id="fechaElaboracion" 
                                   value="2026-01-24" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fechaAprobacion" class="form-label fw-bold">Fecha de Aprobaci√≥n</label>
                            <input type="date" class="form-control" id="fechaAprobacion" 
                                   value="2026-01-24" required>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="elaboro" class="form-label fw-bold">Elabor√≥</label>
                            <input type="text" class="form-control" id="elaboro" 
                                   value="IDGS. Kenneth de Jes√∫s Alcal√° Beltr√°n" 
                                   placeholder="Mismo que docente" required>
                        </div>
                        <div class="col-md-6">
                            <label for="aprobo" class="form-label fw-bold">Aprob√≥</label>
                            <input type="text" class="form-control" id="aprobo" 
                                   value="Coordinaci√≥n de Inform√°tica Administrativa" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Informaci√≥n del Semestre -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Fechas del Semestre</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="semestre" class="form-label fw-bold">Semestre</label>
                            <input type="text" class="form-control" id="semestre" 
                                   value="2026A" required>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="inicioClases" class="form-label fw-bold">
                                <i class="bi bi-calendar-check"></i> Fecha de inicio de clases
                            </label>
                            <input type="date" class="form-control" id="inicioClases" 
                                   value="2026-02-03" required>
                        </div>
                        <div class="col-md-6">
                            <label for="finClases" class="form-label fw-bold">
                                <i class="bi bi-calendar-x"></i> Fecha de fin de clases
                            </label>
                            <input type="date" class="form-control" id="finClases" 
                                   value="2026-06-09" required>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3 mb-3">
                        <i class="bi bi-info-circle"></i> 
                        <strong>Periodos de Ex√°menes:</strong> Indica los rangos de fechas estimados
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="inicioPrimerParcial" class="form-label fw-bold">
                                <i class="bi bi-clipboard-check"></i> Inicio primer parcial
                            </label>
                            <input type="date" class="form-control" id="inicioPrimerParcial" 
                                   value="2026-03-23">
                        </div>
                        <div class="col-md-6">
                            <label for="finPrimerParcial" class="form-label fw-bold">
                                <i class="bi bi-clipboard-check"></i> Fin primer parcial
                            </label>
                            <input type="date" class="form-control" id="finPrimerParcial" 
                                   value="2026-03-27">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-6">
                            <label for="inicioSegundoParcial" class="form-label fw-bold">
                                <i class="bi bi-clipboard-check"></i> Inicio segundo parcial
                            </label>
                            <input type="date" class="form-control" id="inicioSegundoParcial" 
                                   value="2026-05-25">
                        </div>
                        <div class="col-md-6">
                            <label for="finSegundoParcial" class="form-label fw-bold">
                                <i class="bi bi-clipboard-check"></i> Fin segundo parcial
                            </label>
                            <input type="date" class="form-control" id="finSegundoParcial" 
                                   value="2026-05-29">
                        </div>
                    </div>
                    
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-calendar-range"></i> 
                        Las fechas se ajustar√°n considerando d√≠as festivos y periodos vacacionales UAEM√©x.
                    </div>
                </div>
            </div>

            <!-- Materias -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-book"></i> Unidades de Aprendizaje</h5>
                </div>
                <div class="card-body">
                    <div id="materias-container" class="mb-3"></div>
                    <button type="button" class="btn btn-success btn-lg w-100" onclick="agregarMateria()">
                        <i class="bi bi-plus-circle"></i> Agregar Materia
                    </button>
                </div>
            </div>

            <!-- Viajes de Pr√°ctica -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Viajes de Pr√°ctica (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="tieneViajes">
                        <label class="form-check-label fw-bold" for="tieneViajes">
                            ¬øSe realizar√°n viajes de pr√°ctica durante el semestre?
                        </label>
                    </div>
                    
                    <div id="viajesContainer" style="display: none;">
                        <div class="alert alert-info mb-3">
                            <i class="bi bi-info-circle"></i> Agrega los detalles de cada viaje de pr√°ctica programado
                        </div>
                        <div id="viajes-list" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarViaje()">
                            <i class="bi bi-plus-circle"></i> Agregar Viaje
                        </button>
                    </div>
                </div>
            </div>

            <!-- Temarios -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Temarios (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <strong>Alternativa a escribir unidades:</strong> Usa esto SOLO si no escribiste las unidades arriba
                    </div>
                    <div class="border border-2 border-dashed rounded p-4 text-center" 
                         style="cursor: pointer; background-color: #f8f9fa;"
                         onclick="document.getElementById('temarioFile').click()">
                        <i class="bi bi-cloud-upload" style="font-size: 3rem; color: var(--uaemex-green);"></i>
                        <h5 class="mt-3 mb-2">Haz clic para subir archivos de temario</h5>
                        <p class="text-muted mb-0">
                            Soporta: .txt (recomendado), .pdf, .doc, .docx<br>
                            <span class="text-warning fw-bold">‚ö†Ô∏è M√°ximo: 2-3 p√°ginas</span>
                        </p>
                        <input type="file" id="temarioFile" accept=".txt,.pdf,.doc,.docx" multiple 
                               style="display: none;">
                    </div>
                    <div id="fileName" class="mt-3"></div>
                </div>
            </div>

            <!-- Acciones -->
            <div class="d-grid gap-2 d-md-flex justify-content-md-end mb-4">
                <button type="button" class="btn btn-outline-secondary btn-lg" onclick="limpiarFormulario()">
                    <i class="bi bi-arrow-clockwise"></i> Limpiar
                </button>
                <button type="submit" class="btn btn-uaemex btn-lg">
                    <i class="bi bi-file-earmark-pdf"></i> Generar Planeaci√≥n PDF con IA
                </button>
            </div>
        </form>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="text-center">
            <div class="spinner-border text-light" role="status" style="width: 5rem; height: 5rem; border-width: 0.5rem;">
                <span class="visually-hidden">Cargando...</span>
            </div>
            <h4 id="loadingText" class="text-white mt-4 mb-2">Generando...</h4>
            <p id="loadingSubtext" class="text-white-50"></p>
        </div>
    </div>
</div>

<script>
// El token se configura en el formulario y se guarda en el navegador
let GITHUB_API_KEY = localStorage.getItem('github_api_token') || '';

// D√≠as festivos UAEMex 2026
const DIAS_FESTIVOS = [
    new Date(2026, 1, 2), new Date(2026, 2, 16), new Date(2026, 3, 2), new Date(2026, 3, 3),
    new Date(2026, 4, 1), new Date(2026, 4, 5), new Date(2026, 8, 16), new Date(2026, 10, 2),
    new Date(2026, 10, 16), new Date(2026, 11, 25)
];

const VACACIONES = [
    { inicio: new Date(2026, 3, 6), fin: new Date(2026, 3, 17) },
    { inicio: new Date(2026, 6, 19), fin: new Date(2026, 7, 7) },
    { inicio: new Date(2026, 11, 21), fin: new Date(2027, 0, 3) }
];

let materiaCount = 0;
let viajeCount = 0;
let filesContent = [];
let AI_ENABLED = true;

document.addEventListener('DOMContentLoaded', () => {
    agregarMateria();
    
    // Cargar token guardado
    const tokenInput = document.getElementById('apiToken');
    if (GITHUB_API_KEY) {
        tokenInput.value = GITHUB_API_KEY;
    }
    
    // Toggle para viajes de pr√°ctica
    document.getElementById('tieneViajes').addEventListener('change', (e) => {
        document.getElementById('viajesContainer').style.display = e.target.checked ? 'block' : 'none';
    });
    
    // Guardar token cuando el usuario termine de escribir (blur) o presione Enter
    tokenInput.addEventListener('blur', (e) => {
        const token = e.target.value.trim();
        if (token) {
            GITHUB_API_KEY = token;
            localStorage.setItem('github_api_token', token);
            
            // Feedback visual
            const originalBorder = e.target.style.borderColor;
            e.target.style.borderColor = '#28a745';
            e.target.style.backgroundColor = '#d1e7dd';
            
            setTimeout(() => {
                e.target.style.borderColor = originalBorder;
                e.target.style.backgroundColor = '';
            }, 1500);
            
            console.log('‚úÖ Token guardado en el navegador');
            console.log('Token guardado:', token.substring(0, 20) + '...');
        }
    });
    
    tokenInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            e.target.blur(); // Trigger blur para guardar
        }
    });
    
    document.getElementById('iaToggle').addEventListener('change', (e) => {
        AI_ENABLED = e.target.checked;
        const status = document.getElementById('iaStatus');
        if (AI_ENABLED) {
            status.textContent = 'ü§ñ IA Activa';
            status.style.backgroundColor = '#d1e7dd';
            status.style.color = '#0f5132';
        } else {
            status.textContent = '‚≠ï IA Inactiva';
            status.style.backgroundColor = '#f8d7da';
            status.style.color = '#842029';
        }
    });
    
    document.getElementById('temarioFile').addEventListener('change', async (e) => {
        const files = Array.from(e.target.files);
        filesContent = [];
        
        if (files.length > 0) {
            document.getElementById('fileName').innerHTML = '<div class="alert alert-info"><i class="bi bi-hourglass-split"></i> Procesando...</div>';
            
            for (const file of files) {
                try {
                    const content = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onload = (e) => resolve(e.target.result);
                        reader.onerror = reject;
                        reader.readAsText(file);
                    });
                    filesContent.push({ nombre: file.name, contenido: content });
                } catch (error) {
                    console.error('Error:', error);
                }
            }
            
            document.getElementById('fileName').innerHTML = `
                <div class="alert alert-success d-flex align-items-center">
                    <i class="bi bi-check-circle-fill me-2"></i>
                    <div>
                        <strong>${files.length} archivo(s) cargado(s):</strong><br>
                        ${files.map(f => `<span class="badge bg-success me-1">${f.name}</span>`).join('')}
                    </div>
                </div>
            `;
        }
    });
    
    document.getElementById('planeacionForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const datos = {
            // Informaci√≥n institucional completa
            plantel: document.getElementById('plantel').value,
            licenciatura: document.getElementById('licenciatura').value,
            programaEducativo: document.getElementById('programaEducativo').value,
            areaCurricular: document.getElementById('areaCurricular').value,
            clave: document.getElementById('clave').value,
            horasTeoria: parseInt(document.getElementById('horasTeoria').value) || 0,
            horasPractica: parseInt(document.getElementById('horasPractica').value) || 0,
            totalHoras: parseInt(document.getElementById('totalHoras').value) || 0,
            creditos: parseInt(document.getElementById('creditos').value) || 0,
            tipoUnidad: document.getElementById('tipoUnidad').value,
            caracter: document.getElementById('caracter').value,
            nucleoFormacion: document.getElementById('nucleoFormacion').value,
            modalidad: document.getElementById('modalidad').value,
            prerrequisitos: document.getElementById('prerrequisitos').value,
            unidadAntecedente: document.getElementById('unidadAntecedente').value,
            unidadConsecuente: document.getElementById('unidadConsecuente').value,
            docente: document.getElementById('docente').value,
            elaboro: document.getElementById('elaboro').value,
            aprobo: document.getElementById('aprobo').value,
            fechaElaboracion: new Date(document.getElementById('fechaElaboracion').value),
            fechaAprobacion: new Date(document.getElementById('fechaAprobacion').value),
            semestre: document.getElementById('semestre').value,
            inicioClases: new Date(document.getElementById('inicioClases').value),
            finClases: new Date(document.getElementById('finClases').value),
            inicioPrimerParcial: new Date(document.getElementById('inicioPrimerParcial').value),
            finPrimerParcial: new Date(document.getElementById('finPrimerParcial').value),
            inicioSegundoParcial: new Date(document.getElementById('inicioSegundoParcial').value),
            finSegundoParcial: new Date(document.getElementById('finSegundoParcial').value),
            materias: [],
            viajes: []
        };
        
        // Recolectar viajes de pr√°ctica
        if (document.getElementById('tieneViajes').checked) {
            document.querySelectorAll('#viajes-list > .card').forEach(viajeCard => {
                const destino = viajeCard.querySelector('.viaje-destino')?.value;
                const fechaSalida = viajeCard.querySelector('.viaje-fecha-salida')?.value;
                const fechaRegreso = viajeCard.querySelector('.viaje-fecha-regreso')?.value;
                const objetivo = viajeCard.querySelector('.viaje-objetivo')?.value;
                const actividades = viajeCard.querySelector('.viaje-actividades')?.value;
                
                if (destino || fechaSalida) {
                    datos.viajes.push({
                        destino,
                        fechaSalida: fechaSalida ? new Date(fechaSalida) : null,
                        fechaRegreso: fechaRegreso ? new Date(fechaRegreso) : null,
                        objetivo,
                        actividades
                    });
                }
            });
        }
        
        document.querySelectorAll('#materias-container > .card').forEach(item => {
            const horarios = [];
            item.querySelectorAll('.horario-dia').forEach((select, index) => {
                const dia = select.value;
                const inicio = item.querySelectorAll('.horario-inicio')[index]?.value;
                const fin = item.querySelectorAll('.horario-fin')[index]?.value;
                if (dia && inicio && fin) horarios.push({ dia, inicio, fin });
            });
            
            const unidades = [];
            item.querySelectorAll('.unidad-item').forEach(u => {
                const nombre = u.querySelector('.unidad-nombre')?.value;
                const objetivo = u.querySelector('.unidad-objetivo')?.value;
                const contenido = u.querySelector('.unidad-contenido')?.value;
                if (nombre || objetivo || contenido) {
                    unidades.push({ nombre, objetivo, contenido });
                }
            });
            
            datos.materias.push({
                nombre: item.querySelector('.materia-nombre').value,
                competencias: item.querySelector('.materia-competencias').value,
                objetivo: item.querySelector('.materia-objetivo').value,
                horarios,
                unidades
            });
        });
        
        if (datos.materias.length === 0) {
            alert('Agrega al menos una materia');
            return;
        }
        
        mostrarCargando(true, 'Preparando...');
        
        try {
            let planeacion;
            if (AI_ENABLED) {
                // Validar que hay token
                if (!GITHUB_API_KEY || GITHUB_API_KEY.trim() === '') {
                    const continuar = confirm(
                        '‚ö†Ô∏è No hay token de GitHub Models configurado.\n\n' +
                        'Para usar IA:\n' +
                        '1. Ve a: https://github.com/settings/tokens\n' +
                        '2. Generate new token (classic)\n' +
                        '3. C√≥pialo y p√©galo en el campo de arriba\n' +
                        '4. Haz clic en "üß™ Probar Token" para verificar\n\n' +
                        '¬øDeseas generar la planeaci√≥n SIN IA?\n' +
                        '(Se usar√° formato b√°sico con fechas autom√°ticas)'
                    );
                    
                    if (!continuar) {
                        mostrarCargando(false);
                        alert('Por favor configura tu token de GitHub Models en la secci√≥n de IA.');
                        return;
                    }
                    
                    planeacion = generarTradicional(datos);
                } else {
                    mostrarCargando(true, 'ü§ñ La IA est√° generando tu planeaci√≥n...');
                    planeacion = await generarConIA(datos);
                }
            } else {
                planeacion = generarTradicional(datos);
            }
            
            mostrarCargando(true, 'Creando PDF...');
            await generarPDF(datos, planeacion);
            
            mostrarCargando(false);
            alert('‚úÖ ¬°Planeaci√≥n generada exitosamente!');
        } catch (error) {
            mostrarCargando(false);
            console.error('Error completo:', error);
            
            if (error.message.includes('demasiado grande') || error.message.includes('413')) {
                const continuar = confirm(
                    '‚ùå El archivo de temario es demasiado grande\n\n' +
                    'Opciones:\n' +
                    '1. Usa un archivo m√°s peque√±o (max 5 p√°ginas)\n' +
                    '2. Edita el archivo para quitar contenido innecesario\n' +
                    '3. Genera sin archivo adjunto\n\n' +
                    '¬øDeseas generar SIN archivo de temario?\n' +
                    '(Usa solo la informaci√≥n del formulario)'
                );
                
                if (continuar) {
                    try {
                        // Guardar archivos y limpiar temporalmente
                        const tempFiles = filesContent;
                        filesContent = [];
                        
                        mostrarCargando(true, 'ü§ñ Generando con IA (sin archivo)...');
                        const planeacionIA = await generarConIA(datos);
                        await generarPDF(datos, planeacionIA);
                        
                        // Restaurar archivos
                        filesContent = tempFiles;
                        
                        mostrarCargando(false);
                        alert('‚úÖ Planeaci√≥n generada con IA (sin usar archivo adjunto)');
                    } catch (err) {
                        mostrarCargando(false);
                        alert('‚ùå Error: ' + err.message);
                    }
                }
            } else if (error.message.includes('Token') || error.message.includes('401')) {
                const continuar = confirm(
                    '‚ùå Error con la API de GitHub Models:\n' +
                    'Tu token es inv√°lido o ha expirado.\n\n' +
                    'SOLUCI√ìN:\n' +
                    '1. Ve a: https://github.com/settings/tokens\n' +
                    '2. Generate new token (classic)\n' +
                    '3. No marques ning√∫n permiso\n' +
                    '4. Copia el nuevo token\n' +
                    '5. P√©galo arriba y pru√©balo con "üß™ Probar Token"\n\n' +
                    '¬øDeseas generar la planeaci√≥n SIN IA por ahora?\n' +
                    '(Se usar√° formato b√°sico con fechas autom√°ticas)'
                );
                
                if (continuar) {
                    try {
                        mostrarCargando(true, 'Generando planeaci√≥n b√°sica...');
                        const planeacionBasica = generarTradicional(datos);
                        await generarPDF(datos, planeacionBasica);
                        mostrarCargando(false);
                        alert('‚úÖ Planeaci√≥n generada sin IA (formato b√°sico)');
                    } catch (err) {
                        mostrarCargando(false);
                        alert('‚ùå Error al generar PDF: ' + err.message);
                    }
                }
            } else {
                alert('‚ùå Error: ' + error.message);
            }
        }
    });
});

function agregarMateria() {
    materiaCount++;
    const div = document.createElement('div');
    div.className = 'card mb-3';
    div.id = `materia-${materiaCount}`;
    div.innerHTML = `
        <div class="card-header bg-light d-flex justify-content-between align-items-center">
            <h6 class="mb-0"><i class="bi bi-book-fill"></i> Materia ${materiaCount}</h6>
            <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">
                <i class="bi bi-trash"></i> Eliminar
            </button>
        </div>
        <div class="card-body">
            <div class="mb-3">
                <label class="form-label fw-bold">Nombre de la Unidad de Aprendizaje</label>
                <input type="text" class="form-control materia-nombre" 
                       placeholder="Ej: Inteligencia de Negocios" required>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Competencias a desarrollar 
                    <small class="text-muted">(Opcional - se puede extraer del temario)</small>
                </label>
                <textarea class="form-control materia-competencias" rows="2" 
                          placeholder="D√©jalo vac√≠o si viene en el archivo de temario"></textarea>
            </div>
            
            <div class="mb-3">
                <label class="form-label fw-bold">Objetivo general 
                    <small class="text-muted">(Opcional - se puede extraer del temario)</small>
                </label>
                <textarea class="form-control materia-objetivo" rows="2" 
                          placeholder="D√©jalo vac√≠o si viene en el archivo de temario"></textarea>
            </div>
            
            <div class="border-top pt-3 mt-3">
                <h6 class="mb-2"><i class="bi bi-list-ol"></i> Unidades del curso 
                    <small class="text-muted">(Opcional - alternativa a subir archivo)</small>
                </h6>
                <p class="text-muted small">Agrega las unidades con su contenido. Esto se usar√° para generar la planeaci√≥n.</p>
                <div id="unidades-${materiaCount}" class="mb-3"></div>
                <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarUnidad(${materiaCount})">
                    <i class="bi bi-plus-circle"></i> Agregar Unidad
                </button>
            </div>
            
            <div class="border-top pt-3 mt-3">
                <h6 class="mb-3"><i class="bi bi-calendar3"></i> Horarios de clase</h6>
                <div id="horarios-${materiaCount}" class="mb-3"></div>
                <button type="button" class="btn btn-outline-success btn-sm" onclick="agregarHorario(${materiaCount})">
                    <i class="bi bi-plus-circle"></i> Agregar Horario
                </button>
            </div>
        </div>
    `;
    document.getElementById('materias-container').appendChild(div);
    agregarHorario(materiaCount);
}

function agregarHorario(materiaId) {
    const div = document.createElement('div');
    div.className = 'card mb-2';
    div.innerHTML = `
        <div class="card-body p-3">
            <div class="row g-2 align-items-end">
                <div class="col-md-4">
                    <label class="form-label small mb-1">D√≠a</label>
                    <select class="form-select horario-dia" required>
                        <option value="">Seleccionar</option>
                        <option value="Lunes">Lunes</option>
                        <option value="Martes">Martes</option>
                        <option value="Mi√©rcoles">Mi√©rcoles</option>
                        <option value="Jueves">Jueves</option>
                        <option value="Viernes">Viernes</option>
                        <option value="S√°bado">S√°bado</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Inicio</label>
                    <input type="time" class="form-control horario-inicio" required>
                </div>
                <div class="col-md-3">
                    <label class="form-label small mb-1">Fin</label>
                    <input type="time" class="form-control horario-fin" required>
                </div>
                <div class="col-md-2">
                    <button type="button" class="btn btn-danger btn-sm w-100" onclick="this.closest('.card').remove()">
                        <i class="bi bi-x-circle"></i>
                    </button>
                </div>
            </div>
        </div>
    `;
    document.getElementById(`horarios-${materiaId}`).appendChild(div);
}

function agregarUnidad(materiaId) {
    const contenedor = document.getElementById(`unidades-${materiaId}`);
    const numUnidad = contenedor.children.length + 1;
    
    const div = document.createElement('div');
    div.className = 'card mb-2';
    div.innerHTML = `
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="bi bi-bookmark-fill"></i> Unidad ${numUnidad}</h6>
                <button type="button" class="btn btn-danger btn-sm" 
                        onclick="this.closest('.card').remove(); renumerarUnidades(${materiaId})">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="mb-2">
                <label class="form-label small mb-1">Nombre de la unidad</label>
                <input type="text" class="form-control form-control-sm unidad-nombre" 
                       placeholder="Ej: Introducci√≥n a BI">
            </div>
            
            <div class="mb-2">
                <label class="form-label small mb-1">Objetivo de la unidad</label>
                <textarea class="form-control form-control-sm unidad-objetivo" rows="2" 
                          placeholder="Qu√© aprender√°n los estudiantes en esta unidad"></textarea>
            </div>
            
            <div class="mb-0">
                <label class="form-label small mb-1">Contenido / Temas</label>
                <textarea class="form-control form-control-sm unidad-contenido" rows="3" 
                          placeholder="1.1 Concepto de BI&#10;1.2 Herramientas&#10;1.3 Aplicaciones..."></textarea>
            </div>
        </div>
    `;
    contenedor.appendChild(div);
}

function renumerarUnidades(materiaId) {
    const contenedor = document.getElementById(`unidades-${materiaId}`);
    Array.from(contenedor.children).forEach((unidad, index) => {
        unidad.querySelector('h6').innerHTML = `<i class="bi bi-bookmark-fill"></i> Unidad ${index + 1}`;
    });
}

function agregarViaje() {
    viajeCount++;
    const div = document.createElement('div');
    div.className = 'card mb-2';
    div.innerHTML = `
        <div class="card-body p-3">
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6 class="mb-0"><i class="bi bi-bus-front"></i> Viaje ${viajeCount}</h6>
                <button type="button" class="btn btn-danger btn-sm" 
                        onclick="this.closest('.card').remove()">
                    <i class="bi bi-trash"></i>
                </button>
            </div>
            
            <div class="row g-2">
                <div class="col-md-6 mb-2">
                    <label class="form-label small mb-1">Destino</label>
                    <input type="text" class="form-control form-control-sm viaje-destino" 
                           placeholder="Ej: Zona arqueol√≥gica de Teotihuac√°n">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Fecha de salida</label>
                    <input type="date" class="form-control form-control-sm viaje-fecha-salida">
                </div>
                <div class="col-md-3 mb-2">
                    <label class="form-label small mb-1">Fecha de regreso</label>
                    <input type="date" class="form-control form-control-sm viaje-fecha-regreso">
                </div>
            </div>
            
            <div class="mb-2">
                <label class="form-label small mb-1">Objetivo del viaje</label>
                <textarea class="form-control form-control-sm viaje-objetivo" rows="2" 
                          placeholder="Ej: Observar y analizar..."></textarea>
            </div>
            
            <div class="mb-0">
                <label class="form-label small mb-1">Actividades a realizar</label>
                <textarea class="form-control form-control-sm viaje-actividades" rows="2" 
                          placeholder="Ej: Recorrido guiado, toma de muestras..."></textarea>
            </div>
        </div>
    `;
    document.getElementById('viajes-list').appendChild(div);
}

async function generarConIA(datos) {
    // Prompt optimizado para generar sesi√≥n por sesi√≥n
    let prompt = `Planeaci√≥n UAEMex detallada SESI√ìN POR SESI√ìN. Periodo: ${datos.inicioClases.toLocaleDateString('es-MX')} - ${datos.finClases.toLocaleDateString('es-MX')}\n\n`;
    
    const m = datos.materias[0];
    
    // Priorizar unidades del formulario sobre archivo
    if (m.unidades && m.unidades.length > 0) {
        prompt += `UNIDADES DEL CURSO:\n`;
        m.unidades.forEach((u, i) => {
            prompt += `Unidad ${i + 1}: ${u.nombre || 'Sin nombre'}\n`;
            if (u.objetivo) prompt += `Objetivo: ${u.objetivo}\n`;
            if (u.contenido) prompt += `Contenido: ${u.contenido}\n`;
            prompt += `\n`;
        });
    } else if (filesContent.length > 0) {
        prompt += `TEMARIO:\n`;
        filesContent.forEach(f => {
            const contenido = f.contenido.substring(0, 2500);
            prompt += `${contenido}${f.contenido.length > 2500 ? '...' : ''}\n\n`;
        });
    }
    
    prompt += `MATERIA: ${m.nombre}\n`;
    if (m.competencias && m.competencias.trim()) {
        prompt += `Competencias: ${m.competencias.substring(0, 150)}\n`;
    }
    prompt += `Horarios: ${m.horarios.map(h => `${h.dia} ${h.inicio}-${h.fin}`).join(', ')}\n\n`;
    
    prompt += `IMPORTANTE: Genera UNA ENTRADA POR CADA SESI√ìN INDIVIDUAL. No agrupes.\n`;
    prompt += `Cada sesi√≥n debe ser una fila en la tabla con tema espec√≠fico y detallado.\n`;
    prompt += `JSON: {"materias":[{"nombre":"...","sesiones":[{"tema":"Introducci√≥n al concepto X","sesiones":1,"fecha":"4 feb","competencia":"El estudiante comprender√°...","unidadTema":"Unidad 1.1 Conceptos b√°sicos"}]}]}\n`;
    prompt += `Genera entre 30-40 sesiones individuales (una por cada clase).`;
    
    const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${GITHUB_API_KEY}`
        },
        body: JSON.stringify({
            model: 'gpt-4o',
            messages: [
                { role: 'system', content: 'Experto en planeaci√≥n UAEMex. Genera JSON con sesiones individuales detalladas.' },
                { role: 'user', content: prompt }
            ],
            temperature: 0.7,
            max_tokens: 3000,
            response_format: { type: "json_object" }
        })
    });
    
    if (!response.ok) {
        if (response.status === 401) {
            throw new Error('Token inv√°lido o expirado.');
        }
        if (response.status === 413) {
            throw new Error('Archivo demasiado grande. Usa archivo m√°s peque√±o.');
        }
        const errorText = await response.text();
        throw new Error(`Error ${response.status}: ${errorText}`);
    }
    
    const data = await response.json();
    
    // Validar que la respuesta tenga el formato esperado
    if (!data.choices || !data.choices[0] || !data.choices[0].message || !data.choices[0].message.content) {
        console.error('Respuesta inesperada de la API:', data);
        throw new Error('La IA no devolvi√≥ una respuesta v√°lida. Intenta de nuevo o usa el modo sin IA.');
    }
    
    const content = data.choices[0].message.content.trim();
    if (!content) {
        throw new Error('La IA devolvi√≥ una respuesta vac√≠a.');
    }
    
    try {
        return JSON.parse(content);
    } catch (parseError) {
        console.error('Error al parsear JSON:', content);
        throw new Error('La respuesta de la IA no es un JSON v√°lido. Intenta de nuevo o usa el modo sin IA.');
    }
}

function generarTradicional(datos) {
    const planeacion = { materias: [] };
    datos.materias.forEach(m => {
        const sesiones = [];
        let fecha = new Date(datos.inicioClases);
        let sesionNum = 1;
        
        // Calcular total de sesiones para dividir en unidades
        const totalSesiones = calcularTotalSesiones(datos.inicioClases, datos.finClases, m.horarios);
        const numUnidades = m.unidades?.length || 4;
        const sesionesPoUnidad = Math.floor(totalSesiones / numUnidades);
        
        while (fecha <= datos.finClases && sesionNum <= totalSesiones) {
            if (!esFestivo(fecha) && !esVacaciones(fecha)) {
                const dia = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'][fecha.getDay()];
                const horario = m.horarios.find(h => h.dia === dia);
                
                if (horario) {
                    const unidadNum = Math.ceil(sesionNum / sesionesPoUnidad);
                    const sesionEnUnidad = ((sesionNum - 1) % sesionesPoUnidad) + 1;
                    
                    let conocimientos = '';
                    let unidadTema = '';
                    
                    if (m.unidades && m.unidades[unidadNum - 1]) {
                        const unidad = m.unidades[unidadNum - 1];
                        const contenidos = unidad.contenido ? unidad.contenido.split('\n').filter(c => c.trim()) : [];
                        const contenidoIdx = Math.min(sesionEnUnidad - 1, contenidos.length - 1);
                        conocimientos = contenidos[contenidoIdx] || `${unidad.nombre} - Parte ${sesionEnUnidad}`;
                        unidadTema = `Unidad ${unidadNum}. ${unidad.nombre}`;
                    } else {
                        conocimientos = `Tema ${sesionNum}`;
                        unidadTema = `Unidad ${unidadNum}`;
                    }
                    
                    sesiones.push({
                        fecha: fecha.toLocaleDateString('es-MX', { day: 'numeric', month: 'short', year: 'numeric' }),
                        conocimientos: conocimientos,
                        estrategiasEnsenanza: 'EXPOSICI√ìN POR EL PROFESOR',
                        estrategiasAprendizaje: 'VISUAL, AUDITIVO Y KINEST√âSICO',
                        tecnicas: 'Elaborar un resumen y un mapa mental, y/o conceptual y/o cuadro sin√≥ptico',
                        recursos: 'AULA DE CLASES, HOJAS, LAPICERO, PROYECTOR, BIBLIOGRAF√çA, LEYES Y REGLAMENTOS RELACIONADOS CON EL TEMA',
                        evidencias: 'Resumen y un mapa mental, y/o conceptual y/o cuadro sin√≥ptico',
                        unidadTema: unidadTema,
                        tema: conocimientos
                    });
                    sesionNum++;
                }
            }
            fecha.setDate(fecha.getDate() + 1);
        }
        
        planeacion.materias.push({ nombre: m.nombre, sesiones });
    });
    return planeacion;
}

function calcularTotalSesiones(inicio, fin, horarios) {
    let fecha = new Date(inicio);
    let count = 0;
    while (fecha <= fin) {
        if (!esFestivo(fecha) && !esVacaciones(fecha)) {
            const dia = ['Domingo','Lunes','Martes','Mi√©rcoles','Jueves','Viernes','S√°bado'][fecha.getDay()];
            if (horarios.find(h => h.dia === dia)) count++;
        }
        fecha.setDate(fecha.getDate() + 1);
    }
    return count;
}

function obtenerMes(m) {
    const meses = ['enero','febrero','marzo','abril','mayo','junio','julio','agosto','septiembre','octubre','noviembre','diciembre'];
    return meses[m];
}

function esFestivo(f) {
    return DIAS_FESTIVOS.some(d => d.getDate()===f.getDate() && d.getMonth()===f.getMonth() && d.getFullYear()===f.getFullYear());
}

function esVacaciones(f) {
    return VACACIONES.some(v => f >= v.inicio && f <= v.fin);
}

async function generarPDF(datos, planeacion) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('portrait');
    const pw = doc.internal.pageSize.getWidth();
    const ph = doc.internal.pageSize.getHeight();
    
    // PORTADA SIMPLIFICADA
    let y = 30;
    doc.setFontSize(12);
    doc.setTextColor(0);
    doc.setFont(undefined, 'bold');
    doc.text('UNIVERSIDAD AUT√ìNOMA DEL ESTADO DE M√âXICO', pw/2, y, {align:'center'});
    y += 7;
    doc.text(`CENTRO UNIVERSITARIO UAEM TEMASCALTEPEC`, pw/2, y, {align:'center'});
    y += 7;
    doc.text(`LICENCIATURA EN ${datos.licenciatura.toUpperCase()}`, pw/2, y, {align:'center'});
    y += 10;
    doc.setFontSize(14);
    doc.text('Planeaci√≥n Docente', pw/2, y, {align:'center'});
    y += 25;
    
    // Informaci√≥n b√°sica
    doc.setFontSize(11);
    doc.setFont(undefined, 'normal');
    doc.text(`Unidad de Aprendizaje: ${datos.materias[0]?.nombre || ''}`, 20, y);
    y += 10;
    doc.text(`Docente: ${datos.docente}`, 20, y);
    y += 10;
    doc.text(`Semestre: ${datos.semestre}`, 20, y);
    
    // P√ÅGINAS DE CONTENIDO POR UNIDAD
    const materia = datos.materias[0];
    const materiaPlan = planeacion.materias[0];
    
    console.log('Materia:', materia);
    console.log('Planeaci√≥n:', materiaPlan);
    console.log('Sesiones totales:', materiaPlan?.sesiones?.length);
    
    if (materia.unidades && materia.unidades.length > 0 && materiaPlan?.sesiones) {
        // Calcular sesiones por unidad
        const totalSesiones = materiaPlan.sesiones.length;
        const numUnidades = materia.unidades.length;
        const sesionesXUnidad = Math.ceil(totalSesiones / numUnidades);
        
        materia.unidades.forEach((unidad, unidadIdx) => {
            doc.addPage();
            
            // T√≠tulo de planeaci√≥n de contenidos
            doc.setFontSize(10);
            doc.setFont(undefined, 'bold');
            doc.text('I. PLANEACI√ìN DE CONTENIDOS POR SESI√ìN.', 14, 15);
            
            // Nombre y objetivo de la unidad
            const unidadData = [
                ['NOMBRE DE LA UNIDAD ' + (unidadIdx + 1) + ':', unidad.nombre || 'Unidad ' + (unidadIdx + 1)],
                ['OBJETIVO DE LA UNIDAD:', unidad.objetivo || '']
            ];
            
            doc.autoTable({
                startY: 20,
                body: unidadData,
                theme: 'grid',
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    lineWidth: 0.5,
                    lineColor: [0, 0, 0]
                },
                columnStyles: {
                    0: { cellWidth: 50, fontStyle: 'bold', fillColor: [180, 180, 180] },
                    1: { cellWidth: 140, fillColor: [255, 255, 255] }
                },
                margin: { left: 10, right: 10 }
            });
            
            // Obtener sesiones para esta unidad
            const inicioIdx = unidadIdx * sesionesXUnidad;
            const finIdx = Math.min((unidadIdx + 1) * sesionesXUnidad, totalSesiones);
            const sesionesUnidad = materiaPlan.sesiones.slice(inicioIdx, finIdx);
            
            console.log(`Unidad ${unidadIdx + 1}: sesiones ${inicioIdx} a ${finIdx}`, sesionesUnidad.length);
            
            // Agregar ex√°menes y viajes en las fechas correspondientes
            const filasTabla = [];
            
            sesionesUnidad.forEach((sesion, idx) => {
                const fechaSesion = new Date(sesion.fecha);
                
                // Verificar si hay examen en esta fecha
                if (esFechaDeExamen(fechaSesion, datos)) {
                    const tipoExamen = getTipoExamen(fechaSesion, datos);
                    filasTabla.push([
                        `Examen\n${sesion.fecha}`,
                        tipoExamen,
                        'EVALUACI√ìN',
                        'EVALUACI√ìN',
                        'ANAL√çTICO',
                        'EXAMEN ESCRITO',
                        'EXAMEN'
                    ]);
                }
                
                // Verificar si hay viaje en esta fecha
                const viajeEnFecha = datos.viajes?.find(v => 
                    v.fechaSalida && 
                    new Date(v.fechaSalida).toDateString() === fechaSesion.toDateString()
                );
                
                if (viajeEnFecha) {
                    filasTabla.push([
                        `Viaje\n${viajeEnFecha.fechaSalida ? new Date(viajeEnFecha.fechaSalida).toLocaleDateString('es-MX') : sesion.fecha}`,
                        `VIAJE DE PR√ÅCTICA\nDestino: ${viajeEnFecha.destino}`,
                        viajeEnFecha.objetivo || '',
                        viajeEnFecha.actividades || 'VISITA GUIADA',
                        'OBSERVACI√ìN DIRECTA',
                        'TRANSPORTE, MATERIALES DE CAMPO',
                        'REPORTE DE VISITA'
                    ]);
                }
                
                // Sesi√≥n normal
                filasTabla.push([
                    `Sesi√≥n ${inicioIdx + idx + 1}\n${sesion.fecha}`,
                    sesion.conocimientos || sesion.tema || '',
                    sesion.estrategiasEnsenanza || 'EXPOSICI√ìN POR EL PROFESOR',
                    sesion.estrategiasAprendizaje || 'VISUAL, AUDITIVO Y KINEST√âSICO',
                    sesion.tecnicas || 'Elaborar un resumen y un mapa mental, y/o conceptual y/o cuadro sin√≥ptico',
                    sesion.recursos || 'AULA DE CLASES, HOJAS, LAPICERO, PROYECTOR, BIBLIOGRAF√çA',
                    sesion.evidencias || 'Resumen y un mapa mental'
                ]);
            });
            
            // Tabla principal con formato de imagen
            doc.autoTable({
                startY: doc.lastAutoTable.finalY + 5,
                head: [[
                    'N¬∞ SESI√ìN Y\nFECHA',
                    'CONOCIMIENTOS',
                    { content: 'ESTRATEGIAS ENSE√ëANZA-APRENDIZAJE', colSpan: 2 },
                    'T√©cnicas para el Aprendizaje',
                    'Recursos Did√°cticos',
                    'Evidencias / Productos'
                ], [
                    '',
                    '',
                    'Estrategias de Ense√±anza',
                    'Estrategias de Aprendizaje',
                    '',
                    '',
                    ''
                ]],
                body: filasTabla,
                theme: 'grid',
                headStyles: {
                    fillColor: [100, 100, 100],
                    textColor: [255, 255, 255],
                    fontSize: 7,
                    fontStyle: 'bold',
                    halign: 'center',
                    valign: 'middle',
                    lineWidth: 0.5,
                    lineColor: [0, 0, 0]
                },
                bodyStyles: {
                    fontSize: 7,
                    cellPadding: 2,
                    lineWidth: 0.5,
                    lineColor: [0, 0, 0],
                    valign: 'top'
                },
                columnStyles: {
                    0: { cellWidth: 22, halign: 'center' },  // Sesi√≥n y fecha
                    1: { cellWidth: 35, halign: 'left' },    // Conocimientos
                    2: { cellWidth: 28, halign: 'left' },    // Estrategias ense√±anza
                    3: { cellWidth: 28, halign: 'left' },    // Estrategias aprendizaje
                    4: { cellWidth: 25, halign: 'left' },    // T√©cnicas
                    5: { cellWidth: 30, halign: 'left' },    // Recursos
                    6: { cellWidth: 25, halign: 'left' }     // Evidencias
                },
                margin: { left: 10, right: 10, bottom: 20 },
                didDrawPage: function(data) {
                    // Footer con n√∫mero de p√°gina
                    doc.setFontSize(7);
                    doc.setTextColor(100);
                    const pageNum = doc.internal.getCurrentPageInfo().pageNumber;
                    doc.text(`${pageNum}`, pw/2, ph - 10, {align: 'center'});
                }
            });
            
            // Si hay m√°s unidades, indicar en la siguiente p√°gina
            if (unidadIdx < materia.unidades.length - 1) {
                const finalY = doc.lastAutoTable.finalY + 10;
                if (finalY < ph - 30) {
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(50, 100, 150);
                    doc.text('NOMBRE DE LA UNIDAD ' + (unidadIdx + 2) + ':', 14, finalY);
                    doc.setFont(undefined, 'normal');
                    doc.text(materia.unidades[unidadIdx + 1]?.nombre || '', 14, finalY + 6);
                }
            }
        });
    } else {
        // Si no hay unidades definidas, generar todo en una p√°gina
        doc.addPage();
        doc.setFontSize(10);
        doc.setFont(undefined, 'bold');
        doc.text('I. PLANEACI√ìN DE CONTENIDOS POR SESI√ìN.', 14, 15);
        
        const filasTabla = [];
        
        if (materiaPlan?.sesiones) {
            materiaPlan.sesiones.forEach((sesion, idx) => {
                filasTabla.push([
                    `Sesi√≥n ${idx + 1}\n${sesion.fecha}`,
                    sesion.conocimientos || sesion.tema || '',
                    sesion.estrategiasEnsenanza || 'EXPOSICI√ìN POR EL PROFESOR',
                    sesion.estrategiasAprendizaje || 'VISUAL, AUDITIVO Y KINEST√âSICO',
                    sesion.tecnicas || 'Elaborar un resumen y un mapa mental',
                    sesion.recursos || 'AULA DE CLASES, PROYECTOR',
                    sesion.evidencias || 'Resumen'
                ]);
            });
        }
        
        doc.autoTable({
            startY: 25,
            head: [[
                'N¬∞ SESI√ìN Y\nFECHA',
                'CONOCIMIENTOS',
                { content: 'ESTRATEGIAS ENSE√ëANZA-APRENDIZAJE', colSpan: 2 },
                'T√©cnicas para el Aprendizaje',
                'Recursos Did√°cticos',
                'Evidencias / Productos'
            ], [
                '',
                '',
                'Estrategias de Ense√±anza',
                'Estrategias de Aprendizaje',
                '',
                '',
                ''
            ]],
            body: filasTabla,
            theme: 'grid',
            headStyles: {
                fillColor: [100, 100, 100],
                textColor: [255, 255, 255],
                fontSize: 7,
                fontStyle: 'bold',
                halign: 'center',
                valign: 'middle'
            },
            bodyStyles: {
                fontSize: 7,
                cellPadding: 2,
                valign: 'top'
            },
            columnStyles: {
                0: { cellWidth: 22, halign: 'center' },
                1: { cellWidth: 35, halign: 'left' },
                2: { cellWidth: 28, halign: 'left' },
                3: { cellWidth: 28, halign: 'left' },
                4: { cellWidth: 25, halign: 'left' },
                5: { cellWidth: 30, halign: 'left' },
                6: { cellWidth: 25, halign: 'left' }
            },
            margin: { left: 10, right: 10 }
        });
    }
    
    const nombreArchivo = `Planeacion_${datos.materias[0]?.nombre.replace(/\s+/g, '_')}_${datos.semestre}.pdf`;
    doc.save(nombreArchivo);
}

// Funciones auxiliares para ex√°menes
function esFechaDeExamen(fecha, datos) {
// Funciones auxiliares para ex√°menes
function esFechaDeExamen(fecha, datos) {
    const f = new Date(fecha);
    const primerIni = new Date(datos.inicioPrimerParcial);
    const primerFin = new Date(datos.finPrimerParcial);
    const segundoIni = new Date(datos.inicioSegundoParcial);
    const segundoFin = new Date(datos.finSegundoParcial);
    
    return (f >= primerIni && f <= primerFin) || (f >= segundoIni && f <= segundoFin);
}

function getTipoExamen(fecha, datos) {
    const f = new Date(fecha);
    const primerIni = new Date(datos.inicioPrimerParcial);
    const primerFin = new Date(datos.finPrimerParcial);
    
    if (f >= primerIni && f <= primerFin) {
        return 'EXAMEN PRIMER PARCIAL';
    }
    return 'EXAMEN SEGUNDO PARCIAL';
}

function mostrarCargando(show, msg) {
    const loading = document.getElementById('loading');
    if (show) {
        loading.classList.add('active');
        if (msg) {
            document.getElementById('loadingText').textContent = msg;
            document.getElementById('loadingSubtext').textContent = AI_ENABLED ? 'ü§ñ Procesando con IA...' : 'Generando...';
        }
    } else {
        loading.classList.remove('active');
    }
}

function limpiarFormulario() {
    if (!confirm('¬øLimpiar todo?')) return;
    document.getElementById('materias-container').innerHTML = '';
    document.getElementById('fileName').innerHTML = '';
    filesContent = [];
    materiaCount = 0;
    agregarMateria();
}

async function probarToken() {
    const token = document.getElementById('apiToken').value.trim();
    const statusDiv = document.getElementById('tokenStatus');
    
    if (!token) {
        statusDiv.innerHTML = '‚ö†Ô∏è Por favor ingresa un token primero';
        statusDiv.style.color = '#856404';
        statusDiv.style.display = 'block';
        return;
    }
    
    statusDiv.innerHTML = '‚è≥ Probando token...';
    statusDiv.style.color = '#666';
    statusDiv.style.display = 'block';
    
    try {
        const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({
                model: 'gpt-4o',
                messages: [{ role: 'user', content: 'test' }],
                max_tokens: 10
            })
        });
        
        if (response.ok) {
            statusDiv.innerHTML = '‚úÖ Token v√°lido y funcionando correctamente';
            statusDiv.style.color = '#0f5132';
            GITHUB_API_KEY = token;
            localStorage.setItem('github_api_token', token);
        } else if (response.status === 401) {
            statusDiv.innerHTML = '‚ùå Token inv√°lido o expirado. <a href="https://github.com/settings/tokens" target="_blank" style="color: #5b5fc7;">Genera uno nuevo aqu√≠</a>';
            statusDiv.style.color = '#842029';
        } else {
            statusDiv.innerHTML = `‚ö†Ô∏è Error ${response.status}. El token puede estar mal configurado.`;
            statusDiv.style.color = '#856404';
        }
    } catch (error) {
        statusDiv.innerHTML = '‚ùå Error de conexi√≥n: ' + error.message;
        statusDiv.style.color = '#842029';
    }
}
</script>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
