<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Planeador Didáctico UAEMéx</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <style>
        :root{--green:#006341;--gold:#B8860B;--light:#00875A;--dark:#004d2e}
        body{background:linear-gradient(135deg,#f5f7fa,#c3cfe2);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;min-height:100vh;padding:20px 0}
        .header{background:linear-gradient(135deg,var(--dark),var(--green));color:white;padding:30px 0;margin-bottom:30px;box-shadow:0 4px 6px rgba(0,0,0,.1)}
        .card{border:none;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.08);margin-bottom:20px}
        .card:hover{box-shadow:0 8px 25px rgba(0,0,0,.15);transform:translateY(-2px)}
        .bg-green{background:linear-gradient(135deg,var(--green),var(--light))!important}
        .card-header{border:none;padding:15px 20px;font-weight:600;font-size:1.1rem;border-radius:15px 15px 0 0!important}
        .btn-green{background:linear-gradient(135deg,var(--green),var(--light));border:none;color:white;padding:12px 30px;border-radius:10px;font-weight:600}
        .btn-green:hover{background:linear-gradient(135deg,var(--light),var(--green));color:white;transform:translateY(-2px)}
        .form-control:focus,.form-select:focus{border-color:var(--green);box-shadow:0 0 0 .25rem rgba(0,99,65,.25)}
        .form-check-input:checked{background-color:var(--green);border-color:var(--green)}
        .loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,99,65,.95);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading.active{display:flex}
        #dropZone.hover{background:var(--green)!important;color:white}
        #dropZone.hover i{color:white!important}
        .file-badge{display:inline-block;background:var(--green);color:white;padding:8px 15px;border-radius:20px;margin:5px}
        @media (max-width:768px){.header h1{font-size:1.5rem}}
    </style>
</head>
<body>
    <div class="header">
        <div class="container text-center">
            <h1 class="display-4 mb-2"><i class="bi bi-journal-text"></i> Planeador Didáctico UAEMéx</h1>
            <p class="lead mb-0">Universidad Autónoma del Estado de México</p>
        </div>
    </div>

    <div class="container py-4">
        <form id="form">
            <!-- IA -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-robot"></i> IA (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="iaToggle" checked>
                        <label class="form-check-label fw-bold" for="iaToggle">
                            <span id="iaStatus">IA Activa</span>
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="token" class="form-label fw-bold"><i class="bi bi-key"></i> Token GitHub Models</label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="token" placeholder="Pega tu token aquí">
                            <button type="button" class="btn btn-outline-success" onclick="probarToken()">
                                <i class="bi bi-lightning"></i> Probar
                            </button>
                        </div>
                        <div id="tokenStatus" class="mt-2" style="display:none"></div>
                        <small class="form-text"><a href="https://github.com/settings/tokens" target="_blank">Obtén tu token aquí</a> - No requiere permisos</small>
                    </div>
                </div>
            </div>

            <!-- Información Básica -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-person-circle"></i> Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="plantel" class="form-label fw-bold">Plantel</label>
                            <input type="text" class="form-control" id="plantel" value="Centro Universitario UAEM Temascaltepec" required>
                        </div>
                        <div class="col-md-3">
                            <label for="licenciatura" class="form-label fw-bold">Licenciatura</label>
                            <input type="text" class="form-control" id="licenciatura" value="Informática Administrativa" required>
                        </div>
                        <div class="col-md-3">
                            <label for="ua" class="form-label fw-bold">Unidad de Aprendizaje</label>
                            <input type="text" class="form-control" id="ua" placeholder="Ej: Business Intelligence" required>
                        </div>
                        <div class="col-md-3">
                            <label for="docente" class="form-label fw-bold">Profesor</label>
                            <input type="text" class="form-control" id="docente" value="IDGS. Kenneth de Jesús Alcalá Beltrán" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fechas del Semestre -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Fechas del Semestre</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label for="semestre" class="form-label fw-bold">Semestre</label>
                            <input type="text" class="form-control" id="semestre" value="2026A" required>
                        </div>
                        <div class="col-md-4">
                            <label for="inicio" class="form-label fw-bold">Inicio de clases</label>
                            <input type="date" class="form-control" id="inicio" value="2026-02-03" required>
                        </div>
                        <div class="col-md-4">
                            <label for="fin" class="form-label fw-bold">Fin de clases</label>
                            <input type="date" class="form-control" id="fin" value="2026-06-09" required>
                        </div>
                    </div>
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> <strong>Periodos de Exámenes:</strong> Indica los rangos de fechas
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="ini1" class="form-label">Inicio 1er parcial</label>
                            <input type="date" class="form-control" id="ini1" value="2026-03-25" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fin1" class="form-label">Fin 1er parcial</label>
                            <input type="date" class="form-control" id="fin1" value="2026-04-09" required>
                        </div>
                        <div class="col-md-3">
                            <label for="ini2" class="form-label">Inicio 2do parcial</label>
                            <input type="date" class="form-control" id="ini2" value="2026-05-29" required>
                        </div>
                        <div class="col-md-3">
                            <label for="fin2" class="form-label">Fin 2do parcial</label>
                            <input type="date" class="form-control" id="fin2" value="2026-06-08" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Horarios de Clase -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar3"></i> Horarios de Clase</h5>
                </div>
                <div class="card-body">
                    <div id="horarios" class="mb-3"></div>
                    <button type="button" class="btn btn-outline-success btn-sm" onclick="addHorario()">
                        <i class="bi bi-plus-circle"></i> Agregar Horario
                    </button>
                </div>
            </div>

            <!-- Viajes de Práctica -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Viajes de Práctica (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="hayViajes">
                        <label class="form-check-label fw-bold" for="hayViajes">¿Habrá viajes de práctica?</label>
                    </div>
                    <div id="viajesDiv" style="display:none">
                        <div id="viajes" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addViaje()">
                            <i class="bi bi-plus-circle"></i> Agregar Viaje
                        </button>
                    </div>
                </div>
            </div>

            <!-- Temarios -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Temarios (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> Puedes subir archivos .txt o .pdf con los temarios o escribir las unidades manualmente abajo
                    </div>
                    <div id="dropZone" style="border:2px dashed var(--green);border-radius:10px;padding:40px;text-align:center;background:#f8f9fa;cursor:pointer;transition:all 0.3s">
                        <i class="bi bi-cloud-upload" style="font-size:3rem;color:var(--green)"></i>
                        <h5 class="mt-3">Arrastra archivos aquí o haz clic para seleccionar</h5>
                        <p class="text-muted mb-0">Archivos TXT o PDF (máximo 2-3 páginas)</p>
                        <input type="file" id="files" accept=".txt,.pdf" multiple style="display:none">
                    </div>
                    <div id="fileList" class="mt-3"></div>
                </div>
            </div>

            <!-- Información de la Materia -->
            <div class="card">
                <div class="card-header bg-green text-white">
                    <h5 class="mb-0"><i class="bi bi-book"></i> Información de la Materia</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label fw-bold">Objetivos del área curricular o disciplinaria</label>
                        <textarea class="form-control" id="competencias" rows="2" placeholder="Objetivos del área curricular o disciplinaria"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Objetivos de la unidad de aprendizaje</label>
                        <textarea class="form-control" id="objetivo" rows="2" placeholder="Objetivos de la unidad de aprendizaje"></textarea>
                    </div>
                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-2"><i class="bi bi-list-ol"></i> Unidades (Opcional si subiste temario)</h6>
                        <div class="alert alert-info small mb-2">
                            <i class="bi bi-info-circle"></i> Si subiste un archivo con el temario arriba, puedes dejar esta sección vacía
                        </div>
                        <div id="unidades" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="addUnidad()">
                            <i class="bi bi-plus-circle"></i> Agregar Unidad
                        </button>
                    </div>
                </div>
            </div>

            <!-- Botón Generar -->
            <div class="text-center">
                <button type="submit" class="btn btn-green btn-lg">
                    <i class="bi bi-file-pdf"></i> Generar Planeación PDF
                </button>
            </div>
        </form>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="text-center text-white">
            <div class="spinner-border" style="width:3rem;height:3rem"></div>
            <h4 class="mt-3" id="loadText">Procesando...</h4>
            <p id="loadSub"></p>
        </div>
    </div>

    <script>
        let viajeID = 0, AI = true, TOKEN = localStorage.getItem('token') || '', FILES = [];

        // Configurar PDF.js
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        if (TOKEN) document.getElementById('token').value = TOKEN;

        document.getElementById('iaToggle').addEventListener('change', e => {
            AI = e.target.checked;
            document.getElementById('iaStatus').textContent = AI ? 'IA Activa' : 'IA Inactiva';
        });

        document.getElementById('hayViajes').addEventListener('change', e => {
            document.getElementById('viajesDiv').style.display = e.target.checked ? 'block' : 'none';
        });

        document.getElementById('token').addEventListener('change', e => {
            TOKEN = e.target.value.trim();
            if (TOKEN) {
                localStorage.setItem('token', TOKEN);
                console.log('Token guardado');
            }
        });

        // Drag and drop functionality
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('files');
        const fileList = document.getElementById('fileList');

        dropZone.addEventListener('click', () => fileInput.click());

        dropZone.addEventListener('dragover', e => {
            e.preventDefault();
            dropZone.classList.add('hover');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('hover');
        });

        dropZone.addEventListener('drop', e => {
            e.preventDefault();
            dropZone.classList.remove('hover');
            const files = e.dataTransfer.files;
            fileInput.files = files;
            procesarArchivos(files);
        });

        fileInput.addEventListener('change', e => {
            procesarArchivos(e.target.files);
        });

        async function procesarArchivos(files) {
            FILES = [];
            fileList.innerHTML = '';
            Array.from(files).forEach(async f => {
                if (f.type === 'text/plain') {
                    // Procesar archivo TXT
                    const r = new FileReader();
                    r.onload = ev => {
                        const c = ev.target.result;
                        if (c.length > 2500) {
                            alert('Archivo muy grande: ' + f.name);
                            return;
                        }
                        FILES.push({ nombre: f.name, contenido: c });
                        mostrarArchivo(f.name);
                    };
                    r.readAsText(f);
                } else if (f.type === 'application/pdf') {
                    // Procesar archivo PDF
                    try {
                        const arrayBuffer = await f.arrayBuffer();
                        const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                        let texto = '';
                        
                        // Extraer texto de todas las páginas
                        for (let i = 1; i <= Math.min(pdf.numPages, 3); i++) {
                            const page = await pdf.getPage(i);
                            const content = await page.getTextContent();
                            const pageText = content.items.map(item => item.str).join(' ');
                            texto += pageText + '\n';
                        }
                        
                        if (texto.length > 2500) {
                            texto = texto.substring(0, 2500);
                            console.log('PDF recortado a 2500 caracteres');
                        }
                        
                        FILES.push({ nombre: f.name, contenido: texto });
                        mostrarArchivo(f.name);
                        console.log('PDF procesado:', f.name, texto.length, 'caracteres');
                    } catch (error) {
                        alert('Error al procesar PDF: ' + f.name + ' - ' + error.message);
                    }
                }
            });
        }

        function mostrarArchivo(nombre) {
            const badge = document.createElement('span');
            badge.className = 'file-badge';
            badge.innerHTML = `<i class="bi bi-file-earmark-text"></i> ${nombre}`;
            fileList.appendChild(badge);
        }



        function addHorario() {
            const container = document.getElementById('horarios');
            if (!container) {
                console.error('No se encontró el contenedor de horarios');
                return;
            }
            const d = document.createElement('div');
            d.className = 'card mb-2';
            d.innerHTML = `
                <div class="card-body p-3">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Día</label>
                            <select class="form-select horario-dia" required>
                                <option value="">Seleccionar</option>
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Miércoles">Miércoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="Sábado">Sábado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Hora inicio</label>
                            <input type="time" class="form-control horario-inicio" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Hora fin</label>
                            <input type="time" class="form-control horario-fin" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="this.closest('.card').remove()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            container.appendChild(d);
        }

        function addUnidad() {
            const cont = document.getElementById('unidades');
            const d = document.createElement('div');
            d.className = 'card mb-2 unidad-item';
            d.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="mb-0"><i class="bi bi-bookmark-fill"></i> Unidad ${cont.children.length + 1}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove(); renumUnidades()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Nombre</label>
                        <input type="text" class="form-control form-control-sm unidad-nombre" placeholder="Ej: Introducción">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Objetivo</label>
                        <textarea class="form-control form-control-sm unidad-objetivo" rows="2" placeholder="Qué aprenderán"></textarea>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small mb-1">Contenido / Temas</label>
                        <textarea class="form-control form-control-sm unidad-contenido" rows="3" placeholder="1.1 Concepto&#10;1.2 Herramientas"></textarea>
                    </div>
                </div>
            `;
            cont.appendChild(d);
        }

        function renumUnidades() {
            const c = document.getElementById('unidades');
            Array.from(c.children).forEach((u, i) => {
                u.querySelector('h6').innerHTML = `<i class="bi bi-bookmark-fill"></i> Unidad ${i + 1}`;
            });
        }

        function addViaje() {
            viajeID++;
            const d = document.createElement('div');
            d.className = 'card mb-2';
            d.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between mb-2">
                        <h6 class="mb-0"><i class="bi bi-bus-front"></i> Viaje ${viajeID}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label class="form-label small mb-1">Destino</label>
                            <input type="text" class="form-control form-control-sm viaje-destino" placeholder="Ej: Teotihuacán">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small mb-1">Fecha salida</label>
                            <input type="date" class="form-control form-control-sm viaje-salida">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small mb-1">Fecha regreso</label>
                            <input type="date" class="form-control form-control-sm viaje-regreso">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Objetivo</label>
                        <textarea class="form-control form-control-sm viaje-objetivo" rows="2" placeholder="Objetivo del viaje"></textarea>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small mb-1">Actividades</label>
                        <textarea class="form-control form-control-sm viaje-actividades" rows="2" placeholder="Actividades"></textarea>
                    </div>
                </div>
            `;
            document.getElementById('viajes').appendChild(d);
        }

        function loading(show, txt = 'Procesando...') {
            const l = document.getElementById('loading');
            l.className = show ? 'loading active' : 'loading';
            if (show) {
                document.getElementById('loadText').textContent = txt;
                document.getElementById('loadSub').textContent = AI ? 'Procesando con IA...' : 'Generando...';
            }
        }

        async function probarToken() {
            const t = document.getElementById('token').value.trim();
            const s = document.getElementById('tokenStatus');
            s.style.display = 'block';
            s.innerHTML = '<span class="text-info">Probando...</span>';

            if (!t) {
                s.innerHTML = 'Ingresa un token primero';
                s.style.color = '#856404';
                return;
            }

            try {
                const r = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${t}` },
                    body: JSON.stringify({ model: 'gpt-4o', messages: [{ role: 'user', content: 'test' }], max_tokens: 10 })
                });

                if (r.ok) {
                    s.innerHTML = 'Token válido';
                    s.style.color = '#0f5132';
                    TOKEN = t;
                    localStorage.setItem('token', t);
                } else if (r.status === 401) {
                    s.innerHTML = 'Token inválido. <a href="https://github.com/settings/tokens" target="_blank">Genera uno nuevo</a>';
                    s.style.color = '#842029';
                } else {
                    s.innerHTML = `Error ${r.status}`;
                    s.style.color = '#856404';
                }
            } catch (e) {
                s.innerHTML = 'Error: ' + e.message;
                s.style.color = '#842029';
            }
        }

        document.getElementById('form').addEventListener('submit', async e => {
            e.preventDefault();

            const datos = {
                plantel: document.getElementById('plantel').value,
                licenciatura: document.getElementById('licenciatura').value,
                ua: document.getElementById('ua').value,
                docente: document.getElementById('docente').value,
                semestre: document.getElementById('semestre').value,
                inicio: new Date(document.getElementById('inicio').value),
                fin: new Date(document.getElementById('fin').value),
                ini1: new Date(document.getElementById('ini1').value),
                fin1: new Date(document.getElementById('fin1').value),
                ini2: new Date(document.getElementById('ini2').value),
                fin2: new Date(document.getElementById('fin2').value),
                materias: [],
                viajes: []
            };

            // Viajes
            if (document.getElementById('hayViajes').checked) {
                document.querySelectorAll('#viajes > .card').forEach(v => {
                    const dest = v.querySelector('.viaje-destino')?.value;
                    const sal = v.querySelector('.viaje-salida')?.value;
                    const reg = v.querySelector('.viaje-regreso')?.value;
                    const obj = v.querySelector('.viaje-objetivo')?.value;
                    const act = v.querySelector('.viaje-actividades')?.value;

                    if (dest || sal) {
                        datos.viajes.push({
                            destino: dest,
                            salida: sal ? new Date(sal) : null,
                            regreso: reg ? new Date(reg) : null,
                            objetivo: obj,
                            actividades: act
                        });
                    }
                });
            }

            // Horarios (de la sección principal)
            const horarios = [];
            document.querySelectorAll('#horarios .horario-dia').forEach((sel, idx) => {
                const dia = sel.value;
                const ini = document.querySelectorAll('#horarios .horario-inicio')[idx]?.value;
                const fin = document.querySelectorAll('#horarios .horario-fin')[idx]?.value;
                if (dia && ini && fin) horarios.push({ dia, inicio: ini, fin });
            });

            // Unidades (de la sección de materia)
            const unidades = [];
            document.querySelectorAll('#unidades .unidad-item').forEach(u => {
                const nom = u.querySelector('.unidad-nombre')?.value;
                const obj = u.querySelector('.unidad-objetivo')?.value;
                const con = u.querySelector('.unidad-contenido')?.value;
                if (nom || obj || con) unidades.push({ nombre: nom, objetivo: obj, contenido: con });
            });

            // Una sola materia
            datos.materias.push({
                nombre: datos.ua, // Usar el nombre de la UA como nombre de la materia
                competencias: document.getElementById('competencias').value,
                objetivo: document.getElementById('objetivo').value,
                horarios,
                unidades
            });

            try {
                let plan;
                if (AI && TOKEN) {
                    loading(true, 'IA generando planeación...');
                    plan = await genIA(datos);
                } else {
                    plan = genBasico(datos);
                }

                loading(true, 'Creando PDF...');
                await genPDF(datos, plan);

                loading(false);
                alert('Planeación generada exitosamente');
            } catch (e) {
                loading(false);
                console.error('Error:', e);
                alert('Error: ' + e.message);
            }
        });

        async function genIA(datos) {
            let p = `Genera planeación pedagógica MUY DETALLADA SESIÓN POR SESIÓN para una clase universitaria.\n\nPeriodo: ${datos.inicio.toLocaleDateString('es-MX')} - ${datos.fin.toLocaleDateString('es-MX')}\n\n`;

            if (FILES.length > 0) {
                p += "TEMARIOS Y CONTENIDOS:\n";
                FILES.forEach(f => p += `\n--- ${f.nombre} ---\n${f.contenido}\n`);
            }

            datos.materias.forEach((m, i) => {
                p += `\nMATERIA: ${m.nombre}\n`;
                if (m.competencias) p += `Objetivos del área: ${m.competencias}\n`;
                if (m.objetivo) p += `Objetivos de la UA: ${m.objetivo}\n`;
                if (m.horarios.length > 0) {
                    p += 'Horarios: ' + m.horarios.map(h => `${h.dia} ${h.inicio}-${h.fin}`).join(', ') + '\n';
                }
                if (m.unidades.length > 0) {
                    p += 'Unidades:\n';
                    m.unidades.forEach((u, ui) => {
                        p += `  ${ui + 1}. ${u.nombre}\n`;
                        if (u.objetivo) p += `     Objetivo: ${u.objetivo}\n`;
                        if (u.contenido) p += `     Contenido: ${u.contenido}\n`;
                    });
                }
            });

            p += `\n\nDevuelve ÚNICAMENTE un objeto JSON válido.\nFormato:\n{\n  "materias": [\n    {\n      "nombre": "Nombre de la materia",\n      "sesiones": [\n        {\n          "numero": 1,\n          "fecha": "YYYY-MM-DD",\n          "unidadTema": "Unidad y tema específico",\n          "conocimientos": "Conceptos y conocimientos que se abordarán (detallado)",\n          "estrategiasEnsenanza": "Actividades del docente: exposición, demostración, uso de recursos, etc. (muy específico)",\n          "estrategiasAprendizaje": "Actividades de los estudiantes: ejercicios, trabajos, investigación, discusión, etc. (muy específico)",\n          "tecnicas": "Técnicas pedagógicas: aprendizaje colaborativo, estudio de casos, mapas conceptuales, etc.",\n          "recursos": "Materiales y recursos didácticos: presentaciones, lecturas, videos, software, artículos, etc.",\n          "evidencias": "Productos evaluables: tareas, reportes, ejercicios, participaciones, ensayos, etc."\n        }\n      ]\n    }\n  ]\n}\n\nINSTRUCCIONES CRÍTICAS:\n1. SOLO devuelve el JSON puro, sin markdown ni texto adicional\n2. SÉ MUY DETALLADO Y ESPECÍFICO en cada campo (120-180 caracteres por campo)\n3. Describe ACCIONES CONCRETAS que el profesor y estudiantes realizarán\n4. En estrategiasEnsenanza especifica: \"Exposición magistral sobre X tema, demostración de Y procedimiento, organización de Z actividad\"\n5. En estrategiasAprendizaje especifica: \"Resolución de ejercicios prácticos, elaboración de mapas mentales, análisis de casos, trabajo en equipo\"\n6. NO uses saltos de línea dentro de strings\n7. Escapa comillas con \\\"\n8. Genera TODAS las sesiones según horarios`;

            const r = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${TOKEN}` },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content: p }],
                    temperature: 0.7,
                    max_tokens: 16000
                })
            });

            if (!r.ok) throw new Error(`Error ${r.status}`);

            const d = await r.json();
            if (!d.choices?.[0]?.message) throw new Error('Respuesta inválida');

            let c = d.choices[0].message.content.trim();
            
            // Remover markdown code blocks y texto adicional
            c = c.replace(/```json\s*/gi, '').replace(/```\s*/g, '');
            c = c.replace(/^[^{]*/, ''); // Remover texto antes del primer {
            c = c.replace(/[^}]*$/, ''); // Remover texto después del último }
            
            // Encontrar el JSON principal
            let jsonMatch = c.match(/\{[\s\S]*\}/);
            if (!jsonMatch) {
                console.error('Respuesta de IA:', c);
                throw new Error('No se encontró JSON en la respuesta de la IA');
            }

            let jsonStr = jsonMatch[0];
            
            // Limpiar el JSON
            // Remover saltos de línea problemáticos dentro de strings
            jsonStr = jsonStr.replace(/"([^"]*?)\n([^"]*?)"/g, (match, p1, p2) => {
                return `"${p1} ${p2}"`; // Reemplazar saltos de línea con espacios
            });
            
            // Remover comas finales antes de ] o }
            jsonStr = jsonStr.replace(/,\s*([\]}])/g, '$1');

            try {
                const parsed = JSON.parse(jsonStr);
                console.log('JSON parseado exitosamente');
                return parsed;
            } catch (parseError) {
                console.error('Error al parsear JSON:', parseError);
                console.error('JSON problemático (primeros 500 chars):', jsonStr.substring(0, 500));
                
                // Último intento: usar modo de generación básica
                console.warn('Usando modo básico debido a error de JSON');
                return genBasico(datos);
            }
        }

        function genBasico(datos) {
            console.log('Generando plan básico con datos:', datos);
            const plan = { materias: [] };

            datos.materias.forEach(m => {
                const sesi = [];
                const dias = m.horarios.map(h => h.dia);
                console.log('Días de clase:', dias);
                
                // Mapeo correcto de días
                const diasSemana = {
                    0: 'Domingo',
                    1: 'Lunes',
                    2: 'Martes',
                    3: 'Miércoles',
                    4: 'Jueves',
                    5: 'Viernes',
                    6: 'Sábado'
                };

                let f = new Date(datos.inicio);
                let n = 1;

                while (f <= datos.fin) {
                    const nombreDia = diasSemana[f.getDay()];
                    if (dias.includes(nombreDia)) {
                        sesi.push({
                            numero: n,
                            fecha: f.toISOString().split('T')[0],
                            unidadTema: `Sesión ${n}`,
                            conocimientos: 'Conceptos y temas a abordar durante la sesión',
                            estrategiasEnsenanza: 'Exposición del tema, demostraciones prácticas, uso de recursos multimedia',
                            estrategiasAprendizaje: 'Participación activa, toma de apuntes, resolución de ejercicios, trabajo individual y colaborativo',
                            tecnicas: 'Aprendizaje activo, aprendizaje colaborativo, resolución de problemas',
                            recursos: 'Presentaciones, material de apoyo, lecturas complementarias, herramientas tecnológicas',
                            evidencias: 'Participación en clase, ejercicios resueltos, tareas individuales'
                        });
                        n++;
                    }
                    f.setDate(f.getDate() + 1);
                }

                console.log(`Generadas ${sesi.length} sesiones`);
                plan.materias.push({ nombre: m.nombre, sesiones: sesi });
            });

            return plan;
        }

        function esExamen(f, datos) {
            const d = new Date(f);
            return (d >= datos.ini1 && d <= datos.fin1) || (d >= datos.ini2 && d <= datos.fin2);
        }

        function tipoExamen(f, datos) {
            const d = new Date(f);
            if (d >= datos.ini1 && d <= datos.fin1) return 'EXAMEN PRIMER PARCIAL';
            if (d >= datos.ini2 && d <= datos.fin2) return 'EXAMEN SEGUNDO PARCIAL';
            return '';
        }

        async function genPDF(datos, plan) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait');
            const pw = doc.internal.pageSize.getWidth();

            // PORTADA
            let y = 30;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MÉXICO', pw/2, y, {align:'center'});
            y += 7;
            doc.text(datos.plantel.toUpperCase(), pw/2, y, {align:'center'});
            y += 7;
            doc.text(`LICENCIATURA EN ${datos.licenciatura.toUpperCase()}`, pw/2, y, {align:'center'});
            y += 10;
            doc.setFontSize(14);
            doc.text('Planeación Docente', pw/2, y, {align:'center'});
            y += 25;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Unidad de Aprendizaje: ${datos.ua || datos.materias[0]?.nombre || ''}`, 20, y);
            y += 10;
            doc.text(`Docente: ${datos.docente}`, 20, y);
            y += 10;
            doc.text(`Semestre: ${datos.semestre}`, 20, y);

            // PÁGINAS DE CONTENIDO
            const mat = datos.materias[0];
            const matPlan = plan.materias?.[0];
            
            console.log('Datos materia:', mat);
            console.log('Plan materia:', matPlan);
            console.log('Plan completo:', plan);

            if (!matPlan || !matPlan.sesiones || matPlan.sesiones.length === 0) {
                console.error('No hay sesiones en el plan');
                alert('Error: No se generaron sesiones. Verifica que hayas agregado horarios y que las fechas sean correctas.');
                return;
            }

            if (mat.unidades?.length > 0 && matPlan?.sesiones) {
                const totSes = matPlan.sesiones.length;
                const numUni = mat.unidades.length;
                const sesXUni = Math.ceil(totSes / numUni);

                mat.unidades.forEach((uni, uIdx) => {
                    doc.addPage();
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('I. PLANEACIÓN DE CONTENIDOS POR SESIÓN', 14, 15);

                    const uniData = [
                        ['NOMBRE DE LA UNIDAD ' + (uIdx + 1) + ':', uni.nombre || 'Unidad ' + (uIdx + 1)],
                        ['OBJETIVO DE LA UNIDAD:', uni.objetivo || '']
                    ];

                    doc.autoTable({
                        startY: 20,
                        body: uniData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 3 },
                        columnStyles: {
                            0: { cellWidth: 50, fontStyle: 'bold', fillColor: [180, 180, 180] },
                            1: { cellWidth: 140, fillColor: [255, 255, 255] }
                        },
                        margin: { left: 10, right: 10 }
                    });

                    const sesUni = matPlan.sesiones.slice(uIdx * sesXUni, (uIdx + 1) * sesXUni);

                    const tData = [];
                    let i = 0;
                    let enExamen1 = false, enExamen2 = false;
                    
                    while (i < sesUni.length) {
                        const s = sesUni[i];
                        const fechaSesion = new Date(s.fecha);
                        
                        // Verificar si estamos entrando al periodo de examen 1
                        if (!enExamen1 && fechaSesion >= datos.ini1 && fechaSesion <= datos.fin1) {
                            enExamen1 = true;
                            const sesionesEnExamen = sesUni.filter(ses => {
                                const f = new Date(ses.fecha);
                                return f >= datos.ini1 && f <= datos.fin1;
                            }).length;
                            
                            tData.push([{
                                content: `Preparación para primer parcial`,
                                colSpan: 2,
                                styles: { halign: 'left', fontStyle: 'normal', fillColor: [255, 255, 255] }
                            }, {
                                content: sesionesEnExamen.toString(),
                                styles: { halign: 'center', fillColor: [255, 255, 255] }
                            }, {
                                content: `${datos.ini1.toLocaleDateString('es-MX', {day: 'numeric', month: 'long'})}`,
                                styles: { halign: 'center', fillColor: [255, 255, 255] }
                            }, {
                                content: 'Revisarán conceptos clave y resolverán dudas para el examen.',
                                colSpan: 3,
                                styles: { halign: 'left', fillColor: [255, 255, 255] }
                            }]);
                            
                            tData.push([{
                                content: 'Examen y revisión Primer parcial',
                                colSpan: 7,
                                styles: { halign: 'left', fontStyle: 'normal', fillColor: [255, 255, 255] }
                            }]);
                            
                            // Saltar todas las sesiones del examen
                            while (i < sesUni.length && new Date(sesUni[i].fecha) <= datos.fin1) {
                                i++;
                            }
                            continue;
                        }
                        
                        // Verificar si estamos entrando al periodo de examen 2
                        if (!enExamen2 && fechaSesion >= datos.ini2 && fechaSesion <= datos.fin2) {
                            enExamen2 = true;
                            const sesionesEnExamen = sesUni.filter(ses => {
                                const f = new Date(ses.fecha);
                                return f >= datos.ini2 && f <= datos.fin2;
                            }).length;
                            
                            tData.push([{
                                content: `Preparación para segundo parcial`,
                                colSpan: 2,
                                styles: { halign: 'left', fontStyle: 'normal', fillColor: [255, 255, 255] }
                            }, {
                                content: sesionesEnExamen.toString(),
                                styles: { halign: 'center', fillColor: [255, 255, 255] }
                            }, {
                                content: `${datos.ini2.toLocaleDateString('es-MX', {day: 'numeric', month: 'long'})}`,
                                styles: { halign: 'center', fillColor: [255, 255, 255] }
                            }, {
                                content: 'Revisarán conceptos clave y resolverán dudas para el examen.',
                                colSpan: 3,
                                styles: { halign: 'left', fillColor: [255, 255, 255] }
                            }]);
                            
                            tData.push([{
                                content: 'Examen y revisión Segundo parcial',
                                colSpan: 7,
                                styles: { halign: 'left', fontStyle: 'normal', fillColor: [255, 255, 255] }
                            }]);
                            
                            // Saltar todas las sesiones del examen
                            while (i < sesUni.length && new Date(sesUni[i].fecha) <= datos.fin2) {
                                i++;
                            }
                            continue;
                        }
                        
                        // Verificar si hay viaje en esta fecha
                        const viaje = datos.viajes.find(v => {
                            if (!v.salida || !v.regreso) return false;
                            const fSalida = new Date(v.salida);
                            const fRegreso = new Date(v.regreso);
                            return fechaSesion >= fSalida && fechaSesion <= fRegreso;
                        });
                        
                        if (viaje) {
                            // Contar sesiones durante el viaje
                            const fSalida = new Date(viaje.salida);
                            const fRegreso = new Date(viaje.regreso);
                            const sesionesEnViaje = sesUni.filter(ses => {
                                const f = new Date(ses.fecha);
                                return f >= fSalida && f <= fRegreso;
                            }).length;
                            
                            tData.push([{
                                content: `VIAJE DE PRÁCTICA: ${viaje.destino}`,
                                colSpan: 2,
                                styles: { halign: 'left', fontStyle: 'bold', fillColor: [200, 255, 200] }
                            }, {
                                content: sesionesEnViaje.toString(),
                                styles: { halign: 'center', fillColor: [200, 255, 200] }
                            }, {
                                content: `${fSalida.toLocaleDateString('es-MX', {day: 'numeric', month: 'long'})} - ${fRegreso.toLocaleDateString('es-MX', {day: 'numeric', month: 'long'})}`,
                                styles: { halign: 'center', fillColor: [200, 255, 200] }
                            }, {
                                content: viaje.objetivo || 'Viaje de práctica',
                                colSpan: 3,
                                styles: { halign: 'left', fillColor: [200, 255, 200] }
                            }]);
                            
                            // Saltar todas las sesiones del viaje
                            while (i < sesUni.length && new Date(sesUni[i].fecha) <= fRegreso) {
                                i++;
                            }
                            continue;
                        }
                        
                        // Sesión normal
                        tData.push([
                            `${s.numero}\n${new Date(s.fecha).toLocaleDateString('es-MX')}`,
                            s.conocimientos,
                            s.estrategiasEnsenanza,
                            s.estrategiasAprendizaje,
                            s.tecnicas,
                            s.recursos,
                            s.evidencias
                        ]);
                        
                        i++;
                    }

                    doc.autoTable({
                        startY: doc.lastAutoTable.finalY + 5,
                        head: [[
                            'N° SESIÓN Y FECHA',
                            'CONOCIMIENTOS',
                            'ESTRATEGIAS ENSEÑANZA',
                            'ESTRATEGIAS APRENDIZAJE',
                            'TÉCNICAS',
                            'RECURSOS',
                            'EVIDENCIAS'
                        ]],
                        body: tData,
                        theme: 'grid',
                        styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
                        headStyles: { fillColor: [0, 99, 65], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' },
                        columnStyles: {
                            0: { cellWidth: 18, halign: 'center' },
                            1: { cellWidth: 26 },
                            2: { cellWidth: 26 },
                            3: { cellWidth: 26 },
                            4: { cellWidth: 26 },
                            5: { cellWidth: 26 },
                            6: { cellWidth: 26 }
                        },
                        margin: { left: 10, right: 10 },
                        didDrawPage: () => {
                            doc.setFontSize(8);
                            doc.text(`Página ${doc.internal.getNumberOfPages()}`, pw/2, doc.internal.pageSize.getHeight() - 10, {align:'center'});
                        }
                    });
                });
            }

            doc.save(`Planeacion_${datos.materias[0]?.nombre.replace(/\s+/g, '_')}_${datos.semestre}.pdf`);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>