<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Planeaciones UAEMéx</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root{--uaemex-green:#006341;--uaemex-gold:#B8860B;--uaemex-light-green:#00875A;--uaemex-dark-green:#004d2e}
        body{background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;min-height:100vh;padding:20px 0}
        .main-header{background:linear-gradient(135deg,var(--uaemex-dark-green),var(--uaemex-green));color:white;padding:30px 0;margin-bottom:30px;box-shadow:0 4px 6px rgba(0,0,0,0.1)}
        .card{border:none;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,0.08);transition:all 0.3s ease;margin-bottom:20px}
        .card:hover{box-shadow:0 8px 25px rgba(0,0,0,0.15);transform:translateY(-2px)}
        .bg-gradient{background:linear-gradient(135deg,var(--uaemex-green),var(--uaemex-light-green))!important}
        .card-header{border:none;padding:15px 20px;font-weight:600;font-size:1.1rem;border-radius:15px 15px 0 0!important}
        .btn-uaemex{background:linear-gradient(135deg,var(--uaemex-green),var(--uaemex-light-green));border:none;color:white;padding:12px 30px;border-radius:10px;font-weight:600;transition:all 0.3s ease}
        .btn-uaemex:hover{background:linear-gradient(135deg,var(--uaemex-light-green),var(--uaemex-green));transform:translateY(-2px);color:white}
        .form-control:focus,.form-select:focus{border-color:var(--uaemex-green);box-shadow:0 0 0 0.25rem rgba(0,99,65,0.25)}
        .form-check-input:checked{background-color:var(--uaemex-green);border-color:var(--uaemex-green)}
        .loading{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,99,65,0.95);display:none;justify-content:center;align-items:center;z-index:9999}
        .loading.active{display:flex}
        @media (max-width:768px){.main-header h1{font-size:1.5rem}.main-header p{font-size:0.9rem}}
    </style>
</head>
<body>
    <div class="main-header">
        <div class="container">
            <div class="text-center">
                <h1 class="display-4 mb-2"><i class="bi bi-journal-text"></i> Generador de Planeaciones</h1>
                <p class="lead mb-0">Universidad Autónoma del Estado de México</p>
            </div>
        </div>
    </div>

    <div class="container py-4">
        <form id="planeacionForm">
            <!-- IA Section -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-robot"></i> Generación con IA (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="iaToggle" checked>
                        <label class="form-check-label fw-bold" for="iaToggle">
                            <span id="iaStatus">IA Activa</span>
                        </label>
                    </div>
                    <div class="mb-3">
                        <label for="apiToken" class="form-label fw-bold">
                            <i class="bi bi-key"></i> Token de GitHub Models
                        </label>
                        <div class="input-group">
                            <input type="password" class="form-control" id="apiToken" placeholder="Pega tu token aquí...">
                            <button type="button" class="btn btn-outline-success" onclick="probarToken()">
                                <i class="bi bi-lightning"></i> Probar
                            </button>
                        </div>
                        <div id="tokenStatus" class="mt-2" style="display:none;"></div>
                        <div class="form-text">
                            <a href="https://github.com/settings/tokens" target="_blank">Obtén tu token aquí</a> - No requiere permisos especiales
                        </div>
                    </div>
                </div>
            </div>

            <!-- Información Básica -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-person-circle"></i> Información Básica</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label for="plantel" class="form-label fw-bold">Plantel</label>
                            <input type="text" class="form-control" id="plantel" value="Centro Universitario UAEM Temascaltepec" required>
                        </div>
                        <div class="col-md-4">
                            <label for="licenciatura" class="form-label fw-bold">Licenciatura</label>
                            <input type="text" class="form-control" id="licenciatura" value="Informática Administrativa" required>
                        </div>
                        <div class="col-md-4">
                            <label for="docente" class="form-label fw-bold">Nombre del Profesor</label>
                            <input type="text" class="form-control" id="docente" value="IDGS. Kenneth de Jesús Alcalá Beltrán" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Fechas del Semestre -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-calendar-event"></i> Fechas del Semestre</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label for="semestre" class="form-label fw-bold">Semestre</label>
                            <input type="text" class="form-control" id="semestre" value="2026A" required>
                        </div>
                        <div class="col-md-4">
                            <label for="inicioClases" class="form-label fw-bold">Inicio de clases</label>
                            <input type="date" class="form-control" id="inicioClases" value="2026-02-03" required>
                        </div>
                        <div class="col-md-4">
                            <label for="finClases" class="form-label fw-bold">Fin de clases</label>
                            <input type="date" class="form-control" id="finClases" value="2026-06-09" required>
                        </div>
                    </div>
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> <strong>Periodos de Exámenes:</strong> Indica los rangos de fechas
                    </div>
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label for="inicioPrimerParcial" class="form-label fw-bold">Inicio 1er parcial</label>
                            <input type="date" class="form-control" id="inicioPrimerParcial" value="2026-03-23" required>
                        </div>
                        <div class="col-md-3">
                            <label for="finPrimerParcial" class="form-label fw-bold">Fin 1er parcial</label>
                            <input type="date" class="form-control" id="finPrimerParcial" value="2026-03-27" required>
                        </div>
                        <div class="col-md-3">
                            <label for="inicioSegundoParcial" class="form-label fw-bold">Inicio 2do parcial</label>
                            <input type="date" class="form-control" id="inicioSegundoParcial" value="2026-05-25" required>
                        </div>
                        <div class="col-md-3">
                            <label for="finSegundoParcial" class="form-label fw-bold">Fin 2do parcial</label>
                            <input type="date" class="form-control" id="finSegundoParcial" value="2026-05-29" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Viajes de Práctica -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-geo-alt"></i> Viajes de Práctica (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="tieneViajes">
                        <label class="form-check-label fw-bold" for="tieneViajes">
                            ¿Se realizarán viajes de práctica?
                        </label>
                    </div>
                    <div id="viajesContainer" style="display:none;">
                        <div id="viajes-list" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarViaje()">
                            <i class="bi bi-plus-circle"></i> Agregar Viaje
                        </button>
                    </div>
                </div>
            </div>

            <!-- Temarios -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-file-earmark-text"></i> Temarios (Opcional)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info mb-3">
                        <i class="bi bi-info-circle"></i> Alternativa: Usa archivos de temario o escribe las unidades manualmente abajo
                    </div>
                    <input type="file" class="form-control" id="fileInput" accept=".txt" multiple>
                    <div class="form-text">Máximo: 2-3 páginas por archivo de texto</div>
                </div>
            </div>

            <!-- Materias -->
            <div class="card">
                <div class="card-header bg-gradient text-white">
                    <h5 class="mb-0"><i class="bi bi-book"></i> Unidades de Aprendizaje</h5>
                </div>
                <div class="card-body">
                    <div id="materias-container"></div>
                    <button type="button" class="btn btn-outline-success" onclick="agregarMateria()">
                        <i class="bi bi-plus-circle"></i> Agregar Materia
                    </button>
                </div>
            </div>

            <!-- Botón Generar -->
            <div class="text-center">
                <button type="submit" class="btn btn-uaemex btn-lg">
                    <i class="bi bi-file-pdf"></i> Generar Planeación PDF
                </button>
            </div>
        </form>
    </div>

    <!-- Loading -->
    <div class="loading" id="loadingOverlay">
        <div class="text-center text-white">
            <div class="spinner-border" style="width:3rem;height:3rem;" role="status"></div>
            <h4 class="mt-3" id="loadingText">Procesando...</h4>
            <p id="loadingSubtext">Por favor espera</p>
        </div>
    </div>

    <script>
        let materiaCount = 0;
        let viajeCount = 0;
        let AI_ENABLED = true;
        let GITHUB_API_KEY = localStorage.getItem('github_api_token') || '';
        let filesContent = [];

        // Cargar token guardado
        if (GITHUB_API_KEY) {
            document.getElementById('apiToken').value = GITHUB_API_KEY;
        }

        // Toggle IA
        document.getElementById('iaToggle').addEventListener('change', function() {
            AI_ENABLED = this.checked;
            const status = document.getElementById('iaStatus');
            status.textContent = AI_ENABLED ? 'IA Activa' : 'IA Inactiva';
        });

        // Toggle viajes
        document.getElementById('tieneViajes').addEventListener('change', function() {
            document.getElementById('viajesContainer').style.display = this.checked ? 'block' : 'none';
        });

        // Guardar token
        document.getElementById('apiToken').addEventListener('change', function() {
            const token = this.value.trim();
            if (token) {
                GITHUB_API_KEY = token;
                localStorage.setItem('github_api_token', token);
                console.log('Token guardado');
            }
        });

        // Leer archivos
        document.getElementById('fileInput').addEventListener('change', function(e) {
            filesContent = [];
            Array.from(e.target.files).forEach(file => {
                const reader = new FileReader();
                reader.onload = function(event) {
                    const content = event.target.result;
                    if (content.length > 2500) {
                        alert('Archivo demasiado grande: ' + file.name + '. Máximo: 2-3 páginas');
                        return;
                    }
                    filesContent.push({ nombre: file.name, contenido: content });
                };
                reader.readAsText(file);
            });
        });

        function agregarMateria() {
            materiaCount++;
            const div = document.createElement('div');
            div.className = 'card mb-3';
            div.innerHTML = `
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5><i class="bi bi-book"></i> Materia ${materiaCount}</h5>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">
                            <i class="bi bi-trash"></i> Eliminar
                        </button>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Nombre de la materia</label>
                        <input type="text" class="form-control materia-nombre" placeholder="Ej: Business Intelligence" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Competencias</label>
                        <textarea class="form-control materia-competencias" rows="2" placeholder="Competencias a desarrollar"></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Objetivo general</label>
                        <textarea class="form-control materia-objetivo" rows="2" placeholder="Opcional si está en el temario"></textarea>
                    </div>
                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-2"><i class="bi bi-list-ol"></i> Unidades</h6>
                        <div id="unidades-${materiaCount}" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-primary btn-sm" onclick="agregarUnidad(${materiaCount})">
                            <i class="bi bi-plus-circle"></i> Agregar Unidad
                        </button>
                    </div>
                    <div class="border-top pt-3 mt-3">
                        <h6 class="mb-3"><i class="bi bi-calendar3"></i> Horarios de clase</h6>
                        <div id="horarios-${materiaCount}" class="mb-3"></div>
                        <button type="button" class="btn btn-outline-success btn-sm" onclick="agregarHorario(${materiaCount})">
                            <i class="bi bi-plus-circle"></i> Agregar Horario
                        </button>
                    </div>
                </div>
            `;
            document.getElementById('materias-container').appendChild(div);
            agregarHorario(materiaCount);
        }

        function agregarHorario(materiaId) {
            const div = document.createElement('div');
            div.className = 'card mb-2';
            div.innerHTML = `
                <div class="card-body p-3">
                    <div class="row g-2 align-items-end">
                        <div class="col-md-4">
                            <label class="form-label small mb-1">Día</label>
                            <select class="form-select horario-dia" required>
                                <option value="">Seleccionar</option>
                                <option value="Lunes">Lunes</option>
                                <option value="Martes">Martes</option>
                                <option value="Miércoles">Miércoles</option>
                                <option value="Jueves">Jueves</option>
                                <option value="Viernes">Viernes</option>
                                <option value="Sábado">Sábado</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Inicio</label>
                            <input type="time" class="form-control horario-inicio" required>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label small mb-1">Fin</label>
                            <input type="time" class="form-control horario-fin" required>
                        </div>
                        <div class="col-md-2">
                            <button type="button" class="btn btn-danger btn-sm w-100" onclick="this.closest('.card').remove()">
                                <i class="bi bi-x-circle"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.getElementById(`horarios-${materiaId}`).appendChild(div);
        }

        function agregarUnidad(materiaId) {
            const contenedor = document.getElementById(`unidades-${materiaId}`);
            const div = document.createElement('div');
            div.className = 'card mb-2 unidad-item';
            div.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-bookmark-fill"></i> Unidad ${contenedor.children.length + 1}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove(); renumerarUnidades(${materiaId})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Nombre</label>
                        <input type="text" class="form-control form-control-sm unidad-nombre" placeholder="Ej: Introducción a BI">
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Objetivo</label>
                        <textarea class="form-control form-control-sm unidad-objetivo" rows="2" placeholder="Qué aprenderán"></textarea>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small mb-1">Contenido / Temas</label>
                        <textarea class="form-control form-control-sm unidad-contenido" rows="3" placeholder="1.1 Concepto&#10;1.2 Herramientas&#10;1.3 Aplicaciones"></textarea>
                    </div>
                </div>
            `;
            contenedor.appendChild(div);
        }

        function renumerarUnidades(materiaId) {
            const contenedor = document.getElementById(`unidades-${materiaId}`);
            Array.from(contenedor.children).forEach((unidad, index) => {
                unidad.querySelector('h6').innerHTML = `<i class="bi bi-bookmark-fill"></i> Unidad ${index + 1}`;
            });
        }

        function agregarViaje() {
            viajeCount++;
            const div = document.createElement('div');
            div.className = 'card mb-2';
            div.innerHTML = `
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h6 class="mb-0"><i class="bi bi-bus-front"></i> Viaje ${viajeCount}</h6>
                        <button type="button" class="btn btn-danger btn-sm" onclick="this.closest('.card').remove()">
                            <i class="bi bi-trash"></i>
                        </button>
                    </div>
                    <div class="row g-2">
                        <div class="col-md-6 mb-2">
                            <label class="form-label small mb-1">Destino</label>
                            <input type="text" class="form-control form-control-sm viaje-destino" placeholder="Ej: Teotihuacán">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small mb-1">Fecha salida</label>
                            <input type="date" class="form-control form-control-sm viaje-fecha-salida">
                        </div>
                        <div class="col-md-3 mb-2">
                            <label class="form-label small mb-1">Fecha regreso</label>
                            <input type="date" class="form-control form-control-sm viaje-fecha-regreso">
                        </div>
                    </div>
                    <div class="mb-2">
                        <label class="form-label small mb-1">Objetivo</label>
                        <textarea class="form-control form-control-sm viaje-objetivo" rows="2" placeholder="Objetivo del viaje"></textarea>
                    </div>
                    <div class="mb-0">
                        <label class="form-label small mb-1">Actividades</label>
                        <textarea class="form-control form-control-sm viaje-actividades" rows="2" placeholder="Actividades a realizar"></textarea>
                    </div>
                </div>
            `;
            document.getElementById('viajes-list').appendChild(div);
        }

        function mostrarCargando(show, texto = 'Procesando...') {
            const overlay = document.getElementById('loadingOverlay');
            overlay.className = show ? 'loading active' : 'loading';
            if (show) {
                document.getElementById('loadingText').textContent = texto;
                document.getElementById('loadingSubtext').textContent = AI_ENABLED ? 'Procesando con IA...' : 'Generando...';
            }
        }

        async function probarToken() {
            const token = document.getElementById('apiToken').value.trim();
            const statusDiv = document.getElementById('tokenStatus');
            statusDiv.style.display = 'block';
            statusDiv.innerHTML = '<span class="text-info">Probando token...</span>';

            if (!token) {
                statusDiv.innerHTML = 'Por favor ingresa un token primero';
                statusDiv.style.color = '#856404';
                return;
            }

            try {
                const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [{ role: 'user', content: 'test' }],
                        max_tokens: 10
                    })
                });

                if (response.ok) {
                    statusDiv.innerHTML = 'Token válido y funcionando correctamente';
                    statusDiv.style.color = '#0f5132';
                    GITHUB_API_KEY = token;
                    localStorage.setItem('github_api_token', token);
                } else if (response.status === 401) {
                    statusDiv.innerHTML = 'Token inválido o expirado. <a href="https://github.com/settings/tokens" target="_blank">Genera uno nuevo</a>';
                    statusDiv.style.color = '#842029';
                } else {
                    statusDiv.innerHTML = `Error ${response.status}. Token mal configurado.`;
                    statusDiv.style.color = '#856404';
                }
            } catch (error) {
                statusDiv.innerHTML = 'Error de conexión: ' + error.message;
                statusDiv.style.color = '#842029';
            }
        }

        document.getElementById('planeacionForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const datos = {
                plantel: document.getElementById('plantel').value,
                licenciatura: document.getElementById('licenciatura').value,
                docente: document.getElementById('docente').value,
                semestre: document.getElementById('semestre').value,
                inicioClases: new Date(document.getElementById('inicioClases').value),
                finClases: new Date(document.getElementById('finClases').value),
                inicioPrimerParcial: new Date(document.getElementById('inicioPrimerParcial').value),
                finPrimerParcial: new Date(document.getElementById('finPrimerParcial').value),
                inicioSegundoParcial: new Date(document.getElementById('inicioSegundoParcial').value),
                finSegundoParcial: new Date(document.getElementById('finSegundoParcial').value),
                materias: [],
                viajes: []
            };

            // Recolectar viajes
            if (document.getElementById('tieneViajes').checked) {
                document.querySelectorAll('#viajes-list > .card').forEach(viajeCard => {
                    const destino = viajeCard.querySelector('.viaje-destino')?.value;
                    const fechaSalida = viajeCard.querySelector('.viaje-fecha-salida')?.value;
                    const fechaRegreso = viajeCard.querySelector('.viaje-fecha-regreso')?.value;
                    const objetivo = viajeCard.querySelector('.viaje-objetivo')?.value;
                    const actividades = viajeCard.querySelector('.viaje-actividades')?.value;

                    if (destino || fechaSalida) {
                        datos.viajes.push({
                            destino,
                            fechaSalida: fechaSalida ? new Date(fechaSalida) : null,
                            fechaRegreso: fechaRegreso ? new Date(fechaRegreso) : null,
                            objetivo,
                            actividades
                        });
                    }
                });
            }

            // Recolectar materias
            document.querySelectorAll('#materias-container > .card').forEach(item => {
                const horarios = [];
                item.querySelectorAll('.horario-dia').forEach((select, index) => {
                    const dia = select.value;
                    const inicio = item.querySelectorAll('.horario-inicio')[index]?.value;
                    const fin = item.querySelectorAll('.horario-fin')[index]?.value;
                    if (dia && inicio && fin) horarios.push({ dia, inicio, fin });
                });

                const unidades = [];
                item.querySelectorAll('.unidad-item').forEach(u => {
                    const nombre = u.querySelector('.unidad-nombre')?.value;
                    const objetivo = u.querySelector('.unidad-objetivo')?.value;
                    const contenido = u.querySelector('.unidad-contenido')?.value;
                    if (nombre || objetivo || contenido) {
                        unidades.push({ nombre, objetivo, contenido });
                    }
                });

                datos.materias.push({
                    nombre: item.querySelector('.materia-nombre').value,
                    competencias: item.querySelector('.materia-competencias').value,
                    objetivo: item.querySelector('.materia-objetivo').value,
                    horarios,
                    unidades
                });
            });

            try {
                let planeacion;
                if (AI_ENABLED && GITHUB_API_KEY) {
                    mostrarCargando(true, 'La IA está generando tu planeación...');
                    planeacion = await generarConIA(datos);
                } else {
                    planeacion = generarTradicional(datos);
                }

                mostrarCargando(true, 'Creando PDF...');
                await generarPDF(datos, planeacion);

                mostrarCargando(false);
                alert('Planeación generada exitosamente');
            } catch (error) {
                mostrarCargando(false);
                console.error('Error:', error);
                alert('Error: ' + error.message);
            }
        });

        async function generarConIA(datos) {
            let prompt = `Genera una planeación didáctica detallada SESIÓN POR SESIÓN.\n\nPeriodo: ${datos.inicioClases.toLocaleDateString('es-MX')} - ${datos.finClases.toLocaleDateString('es-MX')}\n\n`;

            if (filesContent.length > 0) {
                prompt += "TEMARIOS:\n";
                filesContent.forEach(f => prompt += `\n--- ${f.nombre} ---\n${f.contenido}\n`);
            }

            datos.materias.forEach((m, i) => {
                prompt += `\nMATERIA ${i + 1}: ${m.nombre}\n`;
                if (m.competencias) prompt += `Competencias: ${m.competencias}\n`;
                if (m.objetivo) prompt += `Objetivo: ${m.objetivo}\n`;
                if (m.horarios.length > 0) {
                    prompt += 'Horarios: ' + m.horarios.map(h => `${h.dia} ${h.inicio}-${h.fin}`).join(', ') + '\n';
                }
                if (m.unidades.length > 0) {
                    prompt += 'Unidades:\n';
                    m.unidades.forEach((u, ui) => {
                        prompt += `  ${ui + 1}. ${u.nombre}\n`;
                        if (u.objetivo) prompt += `     Objetivo: ${u.objetivo}\n`;
                        if (u.contenido) prompt += `     Contenido: ${u.contenido}\n`;
                    });
                }
            });

            prompt += `\n\nDevuelve un JSON con esta estructura exacta:
{
  "materias": [
    {
      "nombre": "Nombre de la materia",
      "sesiones": [
        {
          "numero": 1,
          "fecha": "YYYY-MM-DD",
          "unidadTema": "Nombre de la unidad o tema",
          "conocimientos": "Conocimientos específicos",
          "estrategiasEnsenanza": "Estrategias del profesor",
          "estrategiasAprendizaje": "Estrategias del estudiante",
          "tecnicas": "Técnicas de aprendizaje",
          "recursos": "Recursos didácticos",
          "evidencias": "Evidencias/productos"
        }
      ]
    }
  ]
}

IMPORTANTE: Genera TODAS las sesiones considerando los horarios de clase. No uses "..." ni omitas sesiones.`;

            const response = await fetch('https://models.inference.ai.azure.com/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GITHUB_API_KEY}`
                },
                body: JSON.stringify({
                    model: 'gpt-4o',
                    messages: [{ role: 'user', content: prompt }],
                    temperature: 0.7,
                    max_tokens: 16000
                })
            });

            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Error ${response.status}: ${errorText}`);
            }

            const data = await response.json();
            if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                throw new Error('Respuesta inválida de la IA');
            }

            const content = data.choices[0].message.content.trim();
            const jsonMatch = content.match(/\{[\s\S]*\}/);
            if (!jsonMatch) throw new Error('No se encontró JSON en la respuesta');

            return JSON.parse(jsonMatch[0]);
        }

        function generarTradicional(datos) {
            const planeacion = { materias: [] };

            datos.materias.forEach(materia => {
                const sesiones = [];
                const horariosDias = materia.horarios.map(h => h.dia);
                const diasSemana = ['Lunes', 'Martes', 'Miércoles', 'Jueves', 'Viernes', 'Sábado'];

                let fecha = new Date(datos.inicioClases);
                let sesionNum = 1;

                while (fecha <= datos.finClases) {
                    const diaNombre = diasSemana[fecha.getDay() - 1];
                    if (horariosDias.includes(diaNombre)) {
                        sesiones.push({
                            numero: sesionNum++,
                            fecha: fecha.toISOString().split('T')[0],
                            unidadTema: `Sesión ${sesionNum - 1}`,
                            conocimientos: 'Por definir',
                            estrategiasEnsenanza: 'Por definir',
                            estrategiasAprendizaje: 'Por definir',
                            tecnicas: 'Por definir',
                            recursos: 'Por definir',
                            evidencias: 'Por definir'
                        });
                    }
                    fecha.setDate(fecha.getDate() + 1);
                }

                planeacion.materias.push({ nombre: materia.nombre, sesiones });
            });

            return planeacion;
        }

        function esFechaDeExamen(fecha, datos) {
            const f = new Date(fecha);
            return (f >= datos.inicioPrimerParcial && f <= datos.finPrimerParcial) ||
                   (f >= datos.inicioSegundoParcial && f <= datos.finSegundoParcial);
        }

        function getTipoExamen(fecha, datos) {
            const f = new Date(fecha);
            if (f >= datos.inicioPrimerParcial && f <= datos.finPrimerParcial) return 'EXAMEN PRIMER PARCIAL';
            if (f >= datos.inicioSegundoParcial && f <= datos.finSegundoParcial) return 'EXAMEN SEGUNDO PARCIAL';
            return '';
        }

        async function generarPDF(datos, planeacion) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('portrait');
            const pw = doc.internal.pageSize.getWidth();

            // PORTADA
            let y = 30;
            doc.setFontSize(12);
            doc.setFont(undefined, 'bold');
            doc.text('UNIVERSIDAD AUTÓNOMA DEL ESTADO DE MÉXICO', pw/2, y, {align:'center'});
            y += 7;
            doc.text(datos.plantel.toUpperCase(), pw/2, y, {align:'center'});
            y += 7;
            doc.text(`LICENCIATURA EN ${datos.licenciatura.toUpperCase()}`, pw/2, y, {align:'center'});
            y += 10;
            doc.setFontSize(14);
            doc.text('Planeación Docente', pw/2, y, {align:'center'});
            y += 25;

            doc.setFontSize(11);
            doc.setFont(undefined, 'normal');
            doc.text(`Unidad de Aprendizaje: ${datos.materias[0]?.nombre || ''}`, 20, y);
            y += 10;
            doc.text(`Docente: ${datos.docente}`, 20, y);
            y += 10;
            doc.text(`Semestre: ${datos.semestre}`, 20, y);

            // PÁGINAS DE CONTENIDO
            const materia = datos.materias[0];
            const materiaPlan = planeacion.materias[0];

            if (materia.unidades && materia.unidades.length > 0 && materiaPlan?.sesiones) {
                const totalSesiones = materiaPlan.sesiones.length;
                const numUnidades = materia.unidades.length;
                const sesionesXUnidad = Math.ceil(totalSesiones / numUnidades);

                materia.unidades.forEach((unidad, unidadIdx) => {
                    doc.addPage();
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('I. PLANEACIÓN DE CONTENIDOS POR SESIÓN', 14, 15);

                    const unidadData = [
                        ['NOMBRE DE LA UNIDAD ' + (unidadIdx + 1) + ':', unidad.nombre || 'Unidad ' + (unidadIdx + 1)],
                        ['OBJETIVO DE LA UNIDAD:', unidad.objetivo || '']
                    ];

                    doc.autoTable({
                        startY: 20,
                        body: unidadData,
                        theme: 'grid',
                        styles: { fontSize: 8, cellPadding: 3 },
                        columnStyles: {
                            0: { cellWidth: 50, fontStyle: 'bold', fillColor: [180, 180, 180] },
                            1: { cellWidth: 140, fillColor: [255, 255, 255] }
                        },
                        margin: { left: 10, right: 10 }
                    });

                    const sesionesUnidad = materiaPlan.sesiones.slice(
                        unidadIdx * sesionesXUnidad,
                        (unidadIdx + 1) * sesionesXUnidad
                    );

                    const tableData = [];
                    sesionesUnidad.forEach(sesion => {
                        if (esFechaDeExamen(sesion.fecha, datos)) {
                            tableData.push([
                                { content: getTipoExamen(sesion.fecha, datos), colSpan: 7, styles: { halign: 'center', fontStyle: 'bold', fillColor: [255, 255, 200] } }
                            ]);
                        }

                        const viajeEnFecha = datos.viajes.find(v => {
                            if (!v.fechaSalida) return false;
                            const fv = new Date(v.fechaSalida);
                            const fs = new Date(sesion.fecha);
                            return fv.toDateString() === fs.toDateString();
                        });

                        if (viajeEnFecha) {
                            tableData.push([
                                { content: `VIAJE DE PRÁCTICA: ${viajeEnFecha.destino}`, colSpan: 7, styles: { halign: 'center', fontStyle: 'bold', fillColor: [200, 255, 200] } }
                            ]);
                        }

                        tableData.push([
                            `${sesion.numero}\n${new Date(sesion.fecha).toLocaleDateString('es-MX')}`,
                            sesion.conocimientos,
                            sesion.estrategiasEnsenanza,
                            sesion.estrategiasAprendizaje,
                            sesion.tecnicas,
                            sesion.recursos,
                            sesion.evidencias
                        ]);
                    });

                    doc.autoTable({
                        startY: doc.lastAutoTable.finalY + 5,
                        head: [[
                            'N° SESIÓN Y FECHA',
                            'CONOCIMIENTOS',
                            'ESTRATEGIAS ENSEÑANZA',
                            'ESTRATEGIAS APRENDIZAJE',
                            'TÉCNICAS',
                            'RECURSOS',
                            'EVIDENCIAS'
                        ]],
                        body: tableData,
                        theme: 'grid',
                        styles: { fontSize: 7, cellPadding: 2, overflow: 'linebreak' },
                        headStyles: { fillColor: [0, 99, 65], textColor: [255, 255, 255], fontStyle: 'bold', halign: 'center' },
                        columnStyles: {
                            0: { cellWidth: 18, halign: 'center' },
                            1: { cellWidth: 26 },
                            2: { cellWidth: 26 },
                            3: { cellWidth: 26 },
                            4: { cellWidth: 26 },
                            5: { cellWidth: 26 },
                            6: { cellWidth: 26 }
                        },
                        margin: { left: 10, right: 10 },
                        didDrawPage: (data) => {
                            doc.setFontSize(8);
                            doc.text(`Página ${doc.internal.getNumberOfPages()}`, pw/2, doc.internal.pageSize.getHeight() - 10, {align:'center'});
                        }
                    });
                });
            }

            doc.save(`Planeacion_${datos.materias[0]?.nombre.replace(/\s+/g, '_')}_${datos.semestre}.pdf`);
        }
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>